<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Startpage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1220;
      --bg-soft: #13172a;
      --fg: #e6e8f0;
      --muted: #a7aec0;
      --card: #171b31;
      --accent: #7c5cff;
      --accent-2: #54d6ff;
      --ok: #36d399;
      --warn: #f4bf50;
      --danger: #ef6a6a;
      --shadow: 0 8px 30px rgba(0,0,0,.25);
      --glass: rgba(255,255,255,0.06);
      --ring: color-mix(in srgb, var(--accent) 55%, transparent);
      --link: var(--accent-2);
      --link-visited: var(--accent-2);
      --card-bg-current: var(--glass);
      --card-border-current: rgba(255,255,255,.06);
      --card-shadow-current: var(--shadow);
      --card-backdrop-current: blur(10px);
      --tile-bg-current: var(--glass);
      --tile-border-current: rgba(255,255,255,.08);
      --tile-shadow-current: var(--shadow);
      --tile-backdrop-current: blur(10px);
      --clock-bg: var(--card-bg-current);
      --clock-border: var(--card-border-current);
      --clock-shadow: var(--card-shadow-current);
      --clock-backdrop: var(--card-backdrop-current);
      --search-bg: var(--card-bg-current);
      --search-border: var(--card-border-current);
      --search-shadow: var(--card-shadow-current);
      --search-backdrop: var(--card-backdrop-current);
    }
    [data-theme="light"] {
      --bg: #f7f8fb;
      --bg-soft: #eef0f7;
      --fg: #0f1220;
      --muted: #5a6378;
      --card: #ffffff;
      --accent: #5b43ff;
      --accent-2: #17a4da;
      --ok: #0e915f;
      --warn: #9e6b00;
      --danger: #c33b3b;
      --shadow: 0 8px 20px rgba(0,0,0,.08);
      --glass: rgba(255,255,255,0.55);
      --ring: color-mix(in srgb, var(--accent) 45%, transparent);
      --link: var(--accent);
      --link-visited: var(--accent);
      --card-border-current: rgba(0,0,0,.06);
      --tile-border-current: rgba(0,0,0,.08);
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--fg);
      background: radial-gradient(1200px 800px at 10% 0%, rgba(124,92,255,.12), transparent 60%),
                  radial-gradient(1200px 800px at 90% 10%, rgba(84,214,255,.10), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg));
      min-height: 100vh;
    }
    /* Links: enforce accessible contrast and disable default purple visited */
    a { color: var(--link); }
    a:visited { color: var(--link-visited); }
    a:hover { color: var(--accent-2); }
    /* Background orbs */
    .bg-orbs { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden }
    .bg-orbs span { position: absolute; filter: blur(60px); opacity: .35; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--accent), transparent 60%);
      animation: float 18s ease-in-out infinite alternate }
    .bg-orbs .o1 { width: 38vmax; height: 38vmax; left: -10vmax; top: -8vmax; }
    .bg-orbs .o2 { width: 30vmax; height: 30vmax; right: -8vmax; top: 2vmax; background: radial-gradient(circle at 70% 30%, var(--accent-2), transparent 60%); animation-duration: 22s }
    .bg-orbs .o3 { width: 28vmax; height: 28vmax; left: 15vmax; bottom: -8vmax; background: radial-gradient(circle at 50% 50%, #36d399, transparent 60%); animation-duration: 26s }
    @keyframes float { to { transform: translateY(4vh) translateX(2vw) scale(1.04) } }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px 40px;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 16px;
      position: relative;
      z-index: 1;
    }

    body[data-card-style="glass"] {
      --card-bg-current: var(--glass);
      --card-border-current: rgba(255,255,255,.06);
      --card-shadow-current: var(--shadow);
      --card-backdrop-current: blur(10px);
      --tile-bg-current: var(--glass);
      --tile-border-current: rgba(255,255,255,.08);
      --tile-shadow-current: var(--shadow);
      --tile-backdrop-current: blur(10px);
    }
    body[data-card-style="solid"] {
      --card-bg-current: var(--bg-soft);
      --card-border-current: rgba(255,255,255,.10);
      --card-shadow-current: 0 4px 18px rgba(0,0,0,.22);
      --card-backdrop-current: none;
      --tile-bg-current: var(--bg-soft);
      --tile-border-current: rgba(255,255,255,.12);
      --tile-shadow-current: 0 4px 18px rgba(0,0,0,.22);
      --tile-backdrop-current: none;
    }
    html[data-theme="light"] body[data-card-style="solid"] {
      --card-border-current: rgba(0,0,0,.06);
      --card-shadow-current: 0 4px 18px rgba(0,0,0,.08);
      --tile-border-current: rgba(0,0,0,.08);
      --tile-shadow-current: 0 4px 18px rgba(0,0,0,.08);
    }
    body[data-card-style="transparent"] {
      --card-bg-current: transparent;
      --card-border-current: rgba(255,255,255,.18);
      --card-shadow-current: none;
      --card-backdrop-current: none;
      --tile-bg-current: transparent;
      --tile-border-current: rgba(255,255,255,.20);
      --tile-shadow-current: none;
      --tile-backdrop-current: none;
    }
    html[data-theme="light"] body[data-card-style="transparent"] {
      --card-border-current: rgba(0,0,0,.12);
      --tile-border-current: rgba(0,0,0,.14);
    }
    body[data-card-style="minimal"] {
      --card-bg-current: color-mix(in srgb, var(--bg) 80%, transparent);
      --card-border-current: rgba(255,255,255,.05);
      --card-shadow-current: 0 2px 12px rgba(0,0,0,.18);
      --card-backdrop-current: none;
      --tile-bg-current: color-mix(in srgb, var(--bg-soft) 85%, transparent);
      --tile-border-current: rgba(255,255,255,.07);
      --tile-shadow-current: 0 2px 12px rgba(0,0,0,.18);
      --tile-backdrop-current: none;
    }
    html[data-theme="light"] body[data-card-style="minimal"] {
      --card-border-current: rgba(0,0,0,.03);
      --tile-border-current: rgba(0,0,0,.04);
    }

    body { transition: background .4s ease; }
    header {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }
    .time {
      display: flex;
      gap: 16px;
      align-items: baseline;
      background: var(--clock-bg);
      border: 1px solid var(--clock-border);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: var(--clock-shadow);
      backdrop-filter: var(--clock-backdrop);
      transition: background .3s ease, border-color .3s ease, box-shadow .3s ease, color .3s ease;
    }
    .time h1 { font-size: 56px; margin: 0; letter-spacing: -1px; font-weight: 700; }
    .time .date { color: var(--muted); font-weight: 500 }

    .controls { display: flex; gap: 8px; align-items: center }
    .btn {
      background: var(--tile-bg-current);
      border: 1px solid var(--tile-border-current);
      color: var(--fg);
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      box-shadow: var(--tile-shadow-current);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select: none;
      backdrop-filter: var(--tile-backdrop-current);
    }
    .btn:hover { transform: translateY(-1px) }
    .btn:active { transform: translateY(0) }
    .btn:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, a:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
    }

    /* Search */
    .search {
      background: var(--search-bg);
      border: 1px solid var(--search-border);
      border-radius: 16px;
      padding: 12px;
      display: grid;
      grid-template-columns: 160px 1fr 56px;
      gap: 8px;
      align-items: center;
      box-shadow: var(--search-shadow);
      backdrop-filter: var(--search-backdrop);
      transition: background .3s ease, border-color .3s ease, box-shadow .3s ease;
    }
    select, input[type="text"], textarea {
      width: 100%;
      background: var(--bg-soft);
      color: var(--fg);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 16px;
      outline: none;
    }
    input[type="text"]::placeholder { color: var(--muted) }
    .search .btn-go { height: 44px; display:flex; align-items:center; justify-content:center }

    /* Grid */
    main.grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }
    .card {
      background: var(--card-bg-current);
      border: 1px solid var(--card-border-current);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--card-shadow-current);
      min-height: 120px;
      backdrop-filter: var(--card-backdrop-current);
      transition: background .3s ease, border-color .3s ease, box-shadow .3s ease;
    }
    .card h3 { margin: 0 0 10px; font-size: 18px }
    .muted { color: var(--muted) }

    /* Widgets sizes */
    .col-4 { grid-column: span 4 }
    .col-6 { grid-column: span 6 }
    .col-8 { grid-column: span 8 }
    .col-12 { grid-column: span 12 }

    /* Todo */
    .todo-input { display:flex; gap:8px; margin-bottom:10px }
    .todo-list { display:flex; flex-direction:column; gap:8px; max-height: 260px; overflow:auto }
    .todo-item { display:flex; align-items:center; gap:10px; background: var(--bg-soft); border:1px solid rgba(255,255,255,.06); padding:10px 12px; border-radius:12px }
    .todo-item input[type="checkbox"]{ width:18px; height:18px }
    .todo-item .title { flex:1 }
    .todo-item.done .title { text-decoration: line-through; color: var(--muted) }

    /* Notes */
    .notes { width: 100%; min-height: 200px; background: var(--bg-soft); color: var(--fg); border:1px solid rgba(255,255,255,.06); border-radius: 12px; padding:12px; resize: vertical }

    
    /* Tiles */
    .tiles {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }
    .tile {
      background: var(--tile-bg-current);
      border: 1px solid var(--tile-border-current);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      box-shadow: var(--tile-shadow-current);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background .3s ease, border-color .3s ease;
      cursor: grab;
      backdrop-filter: var(--tile-backdrop-current);
    }
    .tile:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(0,0,0,.35); }
    .tile:active { cursor: grabbing; }
    .tile .favicon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      overflow: hidden;
      background: var(--bg-soft);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .tile .favicon img { width:100%; height:100%; display:block }
    .tile .meta { display: flex; flex-direction: column; gap: 2px; }
    .tile .meta .title { font-weight: 600; font-size: 16px; color: var(--fg); text-decoration: none; }
    .tile .meta .title:visited { color: var(--fg); }
    .tile .meta .title:hover { text-decoration: underline; color: var(--accent-2); }
    .tile .meta .url { font-size: 12px; color: var(--muted); word-break: break-all; }
    .tile .actions { margin-top: auto; display: flex; gap: 8px; }
    .tile .actions button { background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 14px; transition: color .2s; }
    .tile .actions button:hover { color: var(--accent-2); }

    /* Weather */
    .weather-top { display:flex; align-items:center; justify-content:space-between; gap:8px }
    .weather-main { display:flex; gap:16px; align-items:center; margin-top:8px }
    .weather-temp { font-size:42px; font-weight:700 }
    .weather-minmax { color: var(--muted) }
    .weather-hourly { margin-top:10px; display:flex; gap:10px; overflow:auto }
    .chip { background: var(--bg-soft); padding:6px 10px; border:1px solid rgba(255,255,255,.06); border-radius:999px; font-size:12px; white-space:nowrap }

    /* Recent */
    .recent-list { display:flex; gap:10px; flex-wrap:wrap }
    .recent-list a { text-decoration:none }

    /* Quote */
    .quote { font-style: italic; color: var(--muted) }

    /* Settings modal */
    .modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.5); padding:20px; z-index: 1000 }
    .modal.open { display:flex }
    .modal .sheet { background: var(--card); border:1px solid rgba(255,255,255,.08); padding:16px; border-radius:16px; width:min(780px, 96vw); max-height: min(90vh, 900px); overflow: auto }
    .sheet h4 { margin:0 0 10px }
    .row { display:grid; grid-template-columns: 220px 1fr; gap:10px; align-items:center; margin-bottom:10px }
    .bg-engine { display:flex; flex-direction:column; gap:12px; background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.08); padding:14px; border-radius:16px; }
    .bg-current { display:flex; gap:12px; align-items:stretch; }
    .bg-current-preview { width:160px; min-width:160px; aspect-ratio:16/9; border-radius:12px; background-color: var(--bg-soft); background-size:cover; background-position:center; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
    .bg-current-info { flex:1; display:flex; flex-direction:column; gap:8px; }
    .bg-current-title { font-weight:600; font-size:15px; }
    .bg-current-meta { font-size:12px; color: var(--muted); line-height:1.4; min-height:18px; }
    .bg-quick-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .bg-quick-actions button { padding:8px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--fg); font-size:13px; cursor:pointer; transition: background .2s, border-color .2s, transform .2s; }
    .bg-quick-actions button:hover:not([disabled]) { background: rgba(255,255,255,0.12); }
    .bg-quick-actions button[disabled] { opacity:0.5; cursor:not-allowed; }
    .bg-tabs { display:flex; flex-wrap:wrap; gap:8px; }
    .bg-tab { padding:6px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); color: var(--fg); font-size:14px; cursor:pointer; transition: background .2s, border-color .2s, transform .2s; }
    .bg-tab:hover { transform: translateY(-1px); }
    .bg-tab.active { background: var(--accent); border-color: var(--accent); color:#fff; }
    .bg-panels { display:block; }
    .bg-panel { display:none; margin-top:6px; border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:14px; background: rgba(0,0,0,0.22); backdrop-filter: blur(18px); }
    .bg-panel.active { display:block; }
    .bg-panel h5 { margin:0 0 8px; font-size:14px; font-weight:600; }
    .bg-panel p { margin:0 0 10px; font-size:13px; color: var(--muted); }
    .bg-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; }
    .bg-card { display:flex; flex-direction:column; gap:8px; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:10px; background: rgba(0,0,0,0.18); }
    .bg-card.highlight { border-color: var(--accent); box-shadow:0 0 0 1px color-mix(in srgb, var(--accent) 45%, transparent); }
    .bg-thumb { position:relative; width:100%; aspect-ratio:16/9; border-radius:10px; background-color: var(--bg-soft); background-size:cover; background-position:center; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05); }
    .bg-thumb::after { content:''; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,0.35)); opacity:0; transition: opacity .2s; }
    .bg-card:hover .bg-thumb::after { opacity:1; }
    .bg-card-title { font-weight:600; font-size:14px; }
    .bg-card-meta { font-size:12px; color: var(--muted); }
    .bg-card-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .bg-card-actions button { padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--fg); font-size:13px; cursor:pointer; transition: background .2s, border-color .2s, color .2s; }
    .bg-card-actions button:hover { background: rgba(255,255,255,0.16); }
    .bg-card-actions button[data-active="true"] { background: var(--accent); border-color: var(--accent); color:#fff; }
    .bg-upload-drop { border:2px dashed rgba(255,255,255,0.18); border-radius:14px; padding:20px; text-align:center; color: var(--muted); display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:center; background: rgba(0,0,0,0.18); transition: border-color .2s, background .2s, color .2s; }
    .bg-upload-drop.dragging { border-color: var(--accent); background: rgba(124,92,255,0.12); color: var(--fg); }
    .bg-upload-drop button { padding:8px 16px; border-radius:999px; border:1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); color: var(--fg); cursor:pointer; }
    .bg-upload-note { font-size:12px; color: var(--muted); text-align:center; }
    .bg-collection { border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px; background: rgba(0,0,0,0.18); display:flex; flex-direction:column; gap:8px; }
    .bg-collection-header { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center; }
    .bg-collection-title { font-weight:600; font-size:14px; }
    .bg-collection-count { font-size:12px; color: var(--muted); }
    .bg-collection-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .bg-collection-actions button { padding:6px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--fg); font-size:13px; cursor:pointer; }
    .bg-collection-actions button:hover { background: rgba(255,255,255,0.16); }
    .bg-collection-list { display:flex; flex-direction:column; gap:12px; margin-top:14px; }
    .bg-rotation-grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .bg-rotation-card { background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .bg-rotation-card label { font-weight:600; font-size:13px; }
    .bg-rotation-card input, .bg-rotation-card select, .bg-rotation-card textarea { width:100%; }
    .bg-mini-text { font-size:12px; color: var(--muted); }
    .bg-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background: rgba(0,0,0,0.24); border:1px solid rgba(255,255,255,0.08); font-size:11px; color: var(--muted); }
    .bg-inline-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .bg-selector { display:flex; flex-direction:column; gap:8px; }
    .bg-selector select { width:100%; }
    .bg-favorite-marker { display:inline-flex; align-items:center; gap:4px; font-size:12px; color: var(--muted); }
    .bg-favorite-marker::before { content:'★'; color: var(--accent); }
    .bg-empty { font-size:13px; color: var(--muted); text-align:center; padding:20px; border:1px dashed rgba(255,255,255,0.12); border-radius:12px; background: rgba(0,0,0,0.12); }
    @media (max-width: 720px) {
      .bg-current { flex-direction:column; }
      .bg-current-preview { width:100%; min-width:0; }
      .bg-engine { padding:12px; }
    }

    .sheet input[type="text"], .sheet input[type="url"], .sheet textarea, .sheet select { width:100% }

    /* Tabs */
    .tabs { display:flex; gap:8px; border-bottom: 1px solid rgba(255,255,255,.08); margin: 10px 0 12px; position: sticky; top: 0; background: inherit; padding-bottom: 8px; z-index: 2 }
    .tab-btn { background: var(--glass); border:1px solid rgba(255,255,255,.08); color: var(--fg); padding:8px 12px; border-radius:999px; cursor:pointer }
    .tab-btn.active { background: var(--accent); border-color: var(--accent); color: #fff }
    .tab-panel { display: none }
    .tab-panel.active { display: block }
    body.modal-open { overflow: hidden }

    /* Command Palette */
    #palette .sheet { width: min(640px, 96vw); }
    .palette-input { width:100%; background: var(--bg-soft); color: var(--fg); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px 14px; font-size:16px; margin-bottom:10px }
    .palette-list { list-style:none; margin:0; padding:0; max-height: 360px; overflow:auto }
    .palette-item { padding:10px 12px; border-radius:10px; display:flex; gap:8px; align-items:center; cursor:pointer }
    .palette-item:hover, .palette-item.active { background: var(--bg-soft) }
    .palette-item .k { margin-left:auto; color: var(--muted); font-size:12px }

    /* Weather icon */
    .weather-icon { width:42px; height:42px; display:flex; align-items:center; justify-content:center }

    /* Responsive */
    @media (max-width: 1000px) {
      .tiles { grid-template-columns: repeat(3, 1fr); }
      .col-6 { grid-column: span 12 }
      .col-8 { grid-column: span 12 }
      .col-4 { grid-column: span 12 }
      .search { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .tiles { grid-template-columns: repeat(2, 1fr); }
      .time h1 { font-size: 40px }
    }
  </style>
</head>
<body>
  <div class="bg-orbs"><span class="o1"></span><span class="o2"></span><span class="o3"></span></div>
  <div class="wrap">
    <header>
      <div class="time">
        <h1 id="clock">--:--</h1>
        <div class="date" id="date">—</div>
      </div>
      <div class="controls">
        <button class="btn" id="themeToggle" title="Dark/Light">🌓</button>
        <button class="btn" id="openSettings" title="Einstellungen">⚙</button>
      </div>
    </header>

    <section class="search" id="searchBox">
      <select id="engine"></select>
      <input id="query" type="text" placeholder="Suche… (z. B. !yt lo‑fi, !etc Home)" autocomplete="on" />
      <button class="btn btn-go" id="go">🔍</button>
    </section>

    <main class="grid">
      <section class="card col-6" id="todo">
        <h3>To‑Do</h3>
        <div class="todo-input">
          <input id="todoInput" type="text" placeholder="Neue Aufgabe…" />
          <button class="btn" id="todoAdd">Hinzufügen</button>
          <button class="btn" id="todoClearDone" title="Erledigte entfernen">✓ löschen</button>
        </div>
        <div class="todo-list" id="todoList"></div>
      </section>

      <section class="card col-6" id="notes">
        <h3>Notizen</h3>
        <textarea class="notes" id="notesArea" placeholder="Schreib dir schnell was auf…"></textarea>
      </section>

      <section class="card col-8" id="tilesCard">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
          <h3>Favoriten</h3>
          <div style="display:flex; gap:8px">
            <button class="btn" id="addTile">+ Kachel</button>
            <button class="btn" id="resetTiles" title="Standard wiederherstellen">↺</button>
          </div>
        </div>
        <div class="tiles" id="tiles"></div>
      </section>

      <section class="card col-4" id="weather">
        <div class="weather-top">
          <h3>Wetter heute</h3>
          <div style="display:flex; gap:6px">
            <input type="text" id="cityInput" placeholder="Stadt eingeben…" style="width: 160px" />
            <button class="btn" id="setCity">Setzen</button>
          </div>
        </div>
        <div class="weather-main">
          <div id="weatherIcon" class="weather-icon" aria-hidden="true"></div>
          <div class="weather-temp" id="tempNow">—°</div>
          <div>
            <div id="weatherText" class="muted">Ort wählen…</div>
            <div class="weather-minmax" id="minmax">— / — °C</div>
          </div>
        </div>
        <div class="weather-hourly" id="hourly"></div>
        <div class="muted" id="weatherFoot" style="margin-top:8px; font-size:12px">Quelle: Open‑Meteo</div>
      </section>

      <section class="card col-4" id="quoteCard">
        <h3>Quote / Nerd‑Impulse</h3>
        <div class="quote" id="quote">—</div>
      </section>

      <section class="card col-4" id="recent">
        <h3>Zuletzt</h3>
        <div class="recent-list" id="recentList"></div>
        <div class="muted" style="margin-top:8px; font-size:12px">Hinweis: Zeigt nur Aktionen von dieser Startseite (geklickte Kacheln & Suchen).</div>
      </section>

      <section class="card col-4" id="systemCard">
        <h3>Systemstatus</h3>
        <div id="systemInfo" class="muted">Lade…</div>
      </section>

      <section class="card col-12" id="newsCard">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h3>News</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="newsSource"></select>
            <button class="btn" id="refreshNews" title="Neu laden">↻</button>
          </div>
        </div>
        <ul id="newsList"></ul>
        <div class="muted" style="margin-top:8px; font-size:12px">RSS via AllOrigins (CORS‑Proxy)</div>
      </section>
    </main>

    <footer class="muted" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px">
      <div>Local‑first Dashboard · speichert nur im Browser (localStorage)</div>
      <div>v1.4</div>
    </footer>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex; align-items:center; justify-content:space-between">
        <h4>Einstellungen</h4>
        <button class="btn" id="closeSettings">Schließen</button>
      </div>
      <div class="tabs" role="tablist">
        <button class="tab-btn" data-tab="general" role="tab" aria-selected="true">Allgemein</button>
        <button class="tab-btn" data-tab="background" role="tab">Hintergrund &amp; Erscheinung</button>
        <button class="tab-btn" data-tab="search" role="tab">Suche &amp; Feeds</button>
        <button class="tab-btn" data-tab="widgets" role="tab">Widgets</button>
        <button class="tab-btn" data-tab="data" role="tab">Daten</button>
        <button class="tab-btn" data-tab="guide" role="tab">Guide</button>
      </div>
      <div id="tab-general" class="tab-panel active" role="tabpanel">
        <div class="row">
          <label for="themeSelect">Theme</label>
          <select id="themeSelect">
            <option value="auto">Auto (System)</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>
      </div>
      <div id="tab-background" class="tab-panel" role="tabpanel">
        <div class="row">
          <label for="bgEngine">Hintergrund</label>
          <div id="bgEngine" class="bg-engine">
            <div class="bg-current">
              <div class="bg-current-preview" id="bgCurrentPreview" role="img" aria-label="Aktuelles Hintergrundbild"></div>
              <div class="bg-current-info">
                <div class="bg-current-title" id="bgCurrentTitle">Kein Hintergrund</div>
                <div class="bg-current-meta" id="bgCurrentMeta"></div>
                <div class="bg-quick-actions">
                  <button type="button" id="bgActionRandom" data-action="bg-random">Zufällig neu laden</button>
                  <button type="button" id="bgActionUndo" data-action="bg-undo" disabled>Letztes Bild wiederherstellen</button>
                  <button type="button" id="bgActionLock" data-action="bg-lock">Rotation sperren</button>
                </div>
              </div>
            </div>
            <div class="bg-tabs" id="bgTabs">
              <button type="button" class="bg-tab active" data-panel="presets">Presets</button>
              <button type="button" class="bg-tab" data-panel="favorites">Favoriten</button>
              <button type="button" class="bg-tab" data-panel="uploads">Uploads</button>
              <button type="button" class="bg-tab" data-panel="collections">Sammlungen</button>
              <button type="button" class="bg-tab" data-panel="rotation">Rotation</button>
              <button type="button" class="bg-tab" data-panel="custom">Custom</button>
            </div>
            <div class="bg-panels">
              <div class="bg-panel active" id="bgPanel-presets"></div>
              <div class="bg-panel" id="bgPanel-favorites"></div>
              <div class="bg-panel" id="bgPanel-uploads"></div>
              <div class="bg-panel" id="bgPanel-collections"></div>
              <div class="bg-panel" id="bgPanel-rotation"></div>
              <div class="bg-panel" id="bgPanel-custom"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="tab-search" class="tab-panel" role="tabpanel">
        <div class="row">
          <label>Suchmaschinen</label>
          <div>
            <div class="muted" style="margin-bottom:6px">Unterstützte Bang-Shortcuts: <code>!g !ddg !bing !yt !wiki !maps</code> - Eigene Shortcuts unten</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap" id="enginePills"></div>
          </div>
        </div>
        <div class="row">
          <label for="shortcutConfig">Eigene !Shortcuts</label>
          <div>
            <textarea id="shortcutConfig" rows="5" placeholder='{"!etc":"https://julianverse.de/etc","!git":"https://github.com/{q}"}'></textarea>
            <div class="muted" style="margin-top:6px">Verwende <code>{q}</code> als Platzhalter für die Suchphrase. Ohne <code>{q}</code> wird <code>?q=...</code> angehängt.</div>
          </div>
        </div>
        <div class="row">
          <label for="feedsConfig">Custom RSS-Feeds</label>
          <div>
            <textarea id="feedsConfig" rows="4" placeholder='{"Heise":"https://www.heise.de/rss/heise-atom.xml","Tagesschau":"https://www.tagesschau.de/infoservices/alle-meldungen-100~rss2.xml","TechCrunch":"https://techcrunch.com/feed/"}'></textarea>
            <div class="muted" style="margin-top:6px">JSON: Name - Feed-URL. Diese Liste wird mit den Standardfeeds gemerged.</div>
          </div>
        </div>
      </div>
      <div id="tab-widgets" class="tab-panel" role="tabpanel">
        <div class="row">
          <label>Widgets sichtbar</label>
          <div id="widgetToggles" style="display:flex; gap:12px; flex-wrap:wrap"></div>
        </div>
        <div class="row">
          <label for="defaultCity">Standard-Stadt (Wetter)</label>
          <input id="defaultCity" type="text" placeholder="z.B. Hannover" />
        </div>
        <div class="row">
          <label for="cardStyle">Kachel-Stil</label>
          <div>
            <select id="cardStyle">
              <option value="glass">Glas (Standard)</option>
              <option value="solid">Vollfläche</option>
              <option value="transparent">Transparent</option>
              <option value="minimal">Soft Minimal</option>
            </select>
            <div class="muted" style="margin-top:6px">Wirkt auf alle Widgets & Favoriten-Kacheln.</div>
          </div>
        </div>
        <div class="row">
          <label for="clockColor">Zeit & Datum</label>
          <div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <input type="color" id="clockColor" />
              <button class="btn" id="clockColorReset" type="button">Reset</button>
            </div>
            <div class="muted" style="margin-top:6px">Legt den Hintergrund der Kopfzeile fest (leer = Stil-Vorgabe).</div>
          </div>
        </div>
        <div class="row">
          <label for="searchColor">Suche</label>
          <div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <input type="color" id="searchColor" />
              <button class="btn" id="searchColorReset" type="button">Reset</button>
            </div>
            <div class="muted" style="margin-top:6px">Farbe für den Suchbereich (leer = Stil-Vorgabe).</div>
          </div>
        </div>
        <div class="row">
          <label>Widget-Farben</label>
          <div id="widgetColorEditor" style="display:flex; gap:12px; flex-wrap:wrap"></div>
        </div>
      </div>
      <div id="tab-data" class="tab-panel" role="tabpanel">
        <div class="row">
          <label>Daten</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" id="exportData">Export (.json)</button>
            <button class="btn" id="importData">Import (.json)</button>
            <input type="file" id="importFile" accept="application/json" style="display:none" />
          </div>
        </div>
        <div class="row">
          <label>Hinweis</label>
          <div class="muted" id="dataNote">Export speichert sämtliche Einstellungen & Daten lokal als JSON. Import überschreibt vorhandene Einträge.</div>
        </div>
      </div>    </div>
  </div>

  <!-- Command Palette -->
  <div class="modal" id="palette" aria-hidden="true">
    <div class="sheet">
      <input class="palette-input" id="paletteInput" type="text" placeholder="Befehl oder Favorit suchen… (Strg/⌘+K)" autocomplete="off" />
      <ul id="paletteList" class="palette-list"></ul>
    </div>
  </div>

  <script>
  // ===== Utilities
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
  const store = {
    get: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
  };

  function exportData(){
    const data = {};
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      try { data[k] = JSON.parse(localStorage.getItem(k)); } catch { data[k] = localStorage.getItem(k); }
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    const d = new Date();
    const ts = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    a.href = URL.createObjectURL(blob);
    a.download = `startpage-backup-${ts}.json`;
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
  }
  function importDataFromFile(ev){
    const file = ev.target.files && ev.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const obj = JSON.parse(reader.result);
        if(!obj || typeof obj !== 'object') throw new Error('Invalid JSON');
        if(!confirm('Daten importieren? Bestehende Einträge werden überschrieben.')) return;
        Object.keys(obj).forEach(k=> localStorage.setItem(k, JSON.stringify(obj[k])));
        location.reload();
      } catch(err){ alert('Import fehlgeschlagen: ' + err.message); }
    };
    reader.readAsText(file);
    ev.target.value = '';
  }

  function prettyDate(d=new Date()) {
    const fmt = new Intl.DateTimeFormat(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    return fmt.format(d);
  }

  function openUrl(url, title='Link') {
    addRecent({ title, url });
    window.location.href = url;
  }

  // ===== Clock & Date
  function tickClock(){
    const now = new Date();
    $('#clock').textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    $('#date').textContent = prettyDate(now);
    requestAnimationFrame(()=> setTimeout(tickClock, 1000 - (now.getTime()%1000)));
  }

  // ===== Theme
  function applyTheme(mode){
    const root = document.documentElement;
    if(mode === 'auto'){
      const prefers = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light';
      root.setAttribute('data-theme', prefers);
    } else {
      root.setAttribute('data-theme', mode);
    }
    bgOnThemeChange();
  }

  // ===== Search with engines + bangs + custom shortcuts
  const ENGINES = {
    google: q => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
    ddg: q => `https://duckduckgo.com/?q=${encodeURIComponent(q)}`,
    bing: q => `https://www.bing.com/search?q=${encodeURIComponent(q)}`,
    yt: q => `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`,
    wikipedia: q => `https://de.wikipedia.org/wiki/Spezial:Suche?search=${encodeURIComponent(q)}`,
    maps: q => `https://www.google.com/maps/search/${encodeURIComponent(q)}`
  };
  const BANGS = { '!g':'google', '!ddg':'ddg', '!bing':'bing', '!yt':'yt', '!wiki':'wikipedia', '!maps':'maps' };

  function getShortcuts(){
    return store.get('shortcuts', { '!etc':'https://julianverse.de/etc' });
  }

  function doSearch(){
    let q = $('#query').value.trim();
    if(!q) return;
    const first = q.split(/\s+/)[0];

    // custom shortcuts first
    const shortcuts = getShortcuts();
    if(first.startsWith('!') && shortcuts[first]){
      const rest = q.replace(first, '').trim();
      let target = String(shortcuts[first]);
      if(target.includes('{q}')) target = target.replaceAll('{q}', encodeURIComponent(rest));
      else if(rest) target += (target.includes('?') ? '&' : '?') + 'q=' + encodeURIComponent(rest);
      addRecent({ title: `Shortcut ${first} – ${rest||''}`, url: target });
      window.location.href = target; return;
    }

    // built-in bangs
    let engine = $('#engine').value;
    if(BANGS[first]){ engine = BANGS[first]; q = q.replace(first, '').trim(); }
    const url = ENGINES[engine](q);
    addRecent({ title: `Suche (${engine}) – ${q}`, url });
    window.location.href = url;
  }

  // ===== Todo
  function renderTodos(){
    const list = store.get('todos', []);
    const wrap = $('#todoList');
    wrap.innerHTML = '';
    list.forEach((t, i) => {
      const el = document.createElement('div');
      el.className = 'todo-item' + (t.done ? ' done' : '');
      el.innerHTML = `
        <input type="checkbox" ${t.done?'checked':''} aria-label="Fertig">
        <div class="title">${escapeHtml(t.text)}</div>
        <button class="btn" title="Löschen">🗑</button>
      `;
      el.querySelector('input').addEventListener('change', e=>{
        list[i].done = e.target.checked; store.set('todos', list); renderTodos();
      });
      el.querySelector('button').addEventListener('click', ()=>{
        list.splice(i,1); store.set('todos', list); renderTodos();
      });
      wrap.appendChild(el);
    });
  }

  function addTodo(text){
    const list = store.get('todos', []);
    list.unshift({ text, done:false, ts: Date.now() });
    store.set('todos', list); renderTodos();
  }

  // ===== Notes
  function initNotes(){
    const area = $('#notesArea');
    area.value = store.get('notes','');
    area.addEventListener('input', ()=> store.set('notes', area.value));
  }

  // ===== Tiles (CRUD + drag&drop + favicons)
  function defaultTiles(){
    return [
      { title:'GitHub', url:'https://github.com', key:'gh' },
      { title:'YouTube', url:'https://youtube.com', key:'yt' },
      { title:'Gmail', url:'https://mail.google.com', key:'gm' },
      { title:'ChatGPT', url:'https://chat.openai.com', key:'ai' },
      { title:'Hacker News', url:'https://news.ycombinator.com', key:'hn' },
      { title:'Wikipedia', url:'https://de.wikipedia.org', key:'wk' },
      { title:'Docs', url:'https://devdocs.io', key:'dd' },
      { title:'Calendar', url:'https://calendar.google.com', key:'cal' }
    ];
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }

  function renderTiles(){
    const data = store.get('tiles', defaultTiles());
    const grid = $('#tiles'); grid.innerHTML = '';
    data.forEach((t, i)=>{
      const el = document.createElement('div');
      el.className='tile';
      el.draggable = true;
      const host = (new URL(t.url)).hostname;
      const firstLetter = host.split('.')[0][0]?.toUpperCase() || '·';
      el.innerHTML = `
        <div class="favicon"><img alt="favicon" src="https://www.google.com/s2/favicons?sz=64&domain_url=${encodeURIComponent(t.url)}"></div>
        <div class="meta">
          <a href="#" class="title">${escapeHtml(t.title)}</a>
          <div class="url">${escapeHtml(host)}</div>
        </div>
        <div class="actions">
          <button title="Bearbeiten" aria-label="Bearbeiten">✏️</button>
          <button title="Löschen" aria-label="Löschen">🗑️</button>
        </div>`;

      // Fallback, wenn Favicon nicht lädt → Buchstabe zeigen
      const img = el.querySelector('.favicon img');
      img.addEventListener('error', ()=>{ const fv=el.querySelector('.favicon'); fv.textContent=firstLetter; img.remove(); });

      el.querySelector('.title').addEventListener('click', (e)=>{ e.preventDefault(); openUrl(t.url, t.title); });
      el.querySelectorAll('button')[1].addEventListener('click', ()=>{ data.splice(i,1); store.set('tiles', data); renderTiles(); });
      el.querySelectorAll('button')[0].addEventListener('click', ()=> editTile(i));

      // Drag & drop
      el.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', i.toString());
        el.classList.add('dragging');
      });
      el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
      el.addEventListener('dragover', e=> e.preventDefault());
      el.addEventListener('drop', e=>{
        e.preventDefault();
        const from = +e.dataTransfer.getData('text/plain');
        const to = i; if(from===to) return;
        const item = data.splice(from,1)[0];
        data.splice(to,0,item);
        store.set('tiles', data); renderTiles();
      });

      grid.appendChild(el);
    });
  }

  function editTile(index){
    const data = store.get('tiles', defaultTiles());
    const t = data[index];
    const title = prompt('Titel', t.title);
    if(title===null) return;
    const url = prompt('URL', t.url);
    if(url===null) return;
    try { new URL(url) } catch { alert('Ungültige URL'); return }
    data[index] = { ...t, title, url };
    store.set('tiles', data); renderTiles();
  }

  function addTile(){
    const title = prompt('Titel der Kachel'); if(!title) return;
    const url = prompt('URL (https://…)'); if(!url) return;
    try { new URL(url) } catch { alert('Ungültige URL'); return }
    const data = store.get('tiles', defaultTiles());
    data.unshift({ title, url });
    store.set('tiles', data); renderTiles();
  }

  // ===== Recent actions
  function addRecent(entry){
    const list = store.get('recent', []);
    list.unshift({ ...entry, ts: Date.now() });
    store.set('recent', list.slice(0, 12));
  }
  function renderRecent(){
    const list = store.get('recent', []);
    const wrap = $('#recentList');
    wrap.innerHTML='';
    list.forEach(it=>{
      const a = document.createElement('a');
      a.href = it.url; a.className='chip'; a.textContent = it.title; a.target='_self';
      wrap.appendChild(a);
    })
  }

  // ===== Weather (Open‑Meteo)
  async function lookupCity(name){
    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=de&format=json`);
    if(!res.ok) throw new Error('Geocoding fehlgeschlagen');
    const data = await res.json();
    if(!data || !data.results || !data.results.length) throw new Error('Ort nicht gefunden');
    const c = data.results[0];
    return { name: `${c.name}${c.admin1 ? ', '+c.admin1 : ''}`, lat: c.latitude, lon: c.longitude };
  }

  function wmoText(code){
    const map = { 0:'Klar', 1:'Überwiegend klar', 2:'Wechselhaft', 3:'Bewölkt', 45:'Nebel', 48:'Nebel', 51:'Sprühregen', 53:'Sprühregen', 55:'Sprühregen', 61:'Regen', 63:'Regen', 65:'Starker Regen', 71:'Schnee', 80:'Schauer', 95:'Gewitter' };
    return map[code] || 'Wetter';
  }

  function weatherIconSVG(code){
    const c = Number(code);
    const sun = '<circle cx="20" cy="20" r="8" fill="#FFD166"/><g stroke="#FFD166" stroke-width="2">'
      + '<line x1="20" y1="2" x2="20" y2="8"/>'
      + '<line x1="20" y1="32" x2="20" y2="38"/>'
      + '<line x1="2" y1="20" x2="8" y2="20"/>'
      + '<line x1="32" y1="20" x2="38" y2="20"/>'
      + '<line x1="6" y1="6" x2="10" y2="10"/>'
      + '<line x1="30" y1="30" x2="34" y2="34"/>'
      + '<line x1="6" y1="34" x2="10" y2="30"/>'
      + '<line x1="30" y1="10" x2="34" y2="6"/></g>';
    const cloud = '<ellipse cx="22" cy="24" rx="12" ry="8" fill="#cfd8e3"/><ellipse cx="14" cy="26" rx="9" ry="6" fill="#d9e3ef"/>';
    const rain = '<g stroke="#4dabf7" stroke-width="2"><line x1="14" y1="32" x2="12" y2="38"/><line x1="20" y1="32" x2="18" y2="38"/><line x1="26" y1="32" x2="24" y2="38"/></g>';
    const snow = '<g fill="#a5b4fc"><circle cx="14" cy="34" r="2"/><circle cx="20" cy="34" r="2"/><circle cx="26" cy="34" r="2"/></g>';
    const bolt = '<polygon points="22,30 16,30 24,18 24,24 30,24 22,36" fill="#F59E0B"/>';
    const fog = '<g stroke="#cbd5e1" stroke-width="2"><line x1="10" y1="30" x2="30" y2="30"/><line x1="8" y1="34" x2="28" y2="34"/></g>';
    let body = '';
    if([0,1].includes(c)) body = sun;
    else if([2,3].includes(c)) body = sun + cloud;
    else if([45,48].includes(c)) body = cloud + fog;
    else if([51,53,55,61,63,65,80].includes(c)) body = cloud + rain;
    else if([71].includes(c)) body = cloud + snow;
    else if([95].includes(c)) body = cloud + bolt;
    else body = cloud;
    return `<svg viewBox="0 0 40 40" width="36" height="36" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">${body}</svg>`;
  }
  function updateWeatherIcon(code){
    const el = document.getElementById('weatherIcon');
    if(!el) return;
    try { el.innerHTML = weatherIconSVG(code); } catch { el.textContent = ''; }
  }

  async function loadWeather(){
    const city = store.get('weather.city', 'Hannover');
    $('#cityInput').value = city;
    try {
      const loc = await lookupCity(city);
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=temperature_2m,weathercode&current_weather=true&timezone=auto&daily=temperature_2m_max,temperature_2m_min&forecast_days=1`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Wetter abrufen fehlgeschlagen');
      const data = await res.json();
      const curr = data.current_weather || {};
      updateWeatherIcon(curr.weathercode);
      const t = Math.round(curr.temperature ?? NaN);
      $('#tempNow').textContent = isFinite(t) ? `${t}°C` : '—°C';
      $('#weatherText').textContent = `${loc.name} · ${wmoText(curr.weathercode)}`;
      const dmax = Math.round((data.daily?.temperature_2m_max?.[0]) ?? NaN);
      const dmin = Math.round((data.daily?.temperature_2m_min?.[0]) ?? NaN);
      $('#minmax').textContent = isFinite(dmin)&&isFinite(dmax) ? `${dmin} / ${dmax} °C` : '— / — °C';

      const hours = data.hourly?.time || [];
      const temps = data.hourly?.temperature_2m || [];
      const codes = data.hourly?.weathercode || [];
      const container = $('#hourly'); container.innerHTML='';
      for(let i=0;i<hours.length;i+=3){
        const time = new Date(hours[i]);
        const chip = document.createElement('div');
        chip.className='chip';
        chip.textContent = `${time.toLocaleTimeString([], {hour:'2-digit'})} · ${Math.round(temps[i])}°`;
        chip.title = wmoText(codes[i]);
        container.appendChild(chip);
      }
      // Normalize degree symbols / overwrite any garbled text
      try {
        const t2 = Math.round((data.current_weather||{}).temperature ?? NaN);
        $('#tempNow').textContent = isFinite(t2) ? `${t2}°C` : '-°C';
        const dmax2 = Math.round((data.daily?.temperature_2m_max?.[0]) ?? NaN);
        const dmin2 = Math.round((data.daily?.temperature_2m_min?.[0]) ?? NaN);
        $('#minmax').textContent = isFinite(dmin2)&&isFinite(dmax2) ? `${dmin2} / ${dmax2} °C` : '- / - °C';
      } catch {}
    } catch(err){
      console.warn(err);
      $('#weatherText').textContent = 'Wetter konnte nicht geladen werden.';
      $('#hourly').innerHTML='';
    }
  }

  // ===== Quote of the day (local)
  const QUOTES = [
    'Move fast, refactor often.',
    'Accessibility isn\'t a feature – it\'s the default.',
    'Done > Perfect. Iterate.',
    'If it\'s not monitored, it doesn\'t exist.',
    'Good UX is invisible. Bad UX is unforgettable.',
    'Make it work, make it right, make it fast.',
    'Small steps. Massive outcomes.',
    'Simplicity scales. Complexity fails.',
    'Automate the boring stuff.',
    'Measure twice, deploy once.'
  ];
  function loadQuote(){
    const day = Math.floor(Date.now() / (1000*60*60*24));
    $('#quote').textContent = QUOTES[day % QUOTES.length];
  }

  // ===== News (RSS)
  function defaultFeeds(){
    return {
      'Heise': 'https://www.heise.de/rss/heise-atom.xml',
      'Tagesschau': 'https://www.tagesschau.de/infoservices/alle-meldungen-100~rss2.xml',
      'TechCrunch': 'https://techcrunch.com/feed/'
    };
  }
  function getFeeds(){
    const custom = store.get('news.custom', {});
    return { ...defaultFeeds(), ...custom };
  }
  function fillNewsSources(){
    const select = $('#newsSource');
    const sources = getFeeds();
    const current = store.get('news.source', Object.keys(sources)[0]);
    select.innerHTML='';
    Object.keys(sources).forEach(name=>{
      const opt = document.createElement('option'); opt.value=name; opt.textContent=name; if(name===current) opt.selected=true; select.appendChild(opt);
    });
  }
  async function loadNews(){
    const sources = getFeeds();
    const sourceName = store.get('news.source', Object.keys(sources)[0]);
    const feedUrl = sources[sourceName];
    $('#newsList').innerHTML = '<li class="muted">Lade…</li>';
    try{
      const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(feedUrl)}`);
      const data = await res.json();
      const parser = new DOMParser();
      const xml = parser.parseFromString(data.contents, 'text/xml');
      const items = xml.querySelectorAll('item');
      const ul = $('#newsList'); ul.innerHTML='';
      const max = 8;
      items.forEach((it,i)=>{ if(i<max){
        const title = it.querySelector('title')?.textContent || '—';
        const link = it.querySelector('link')?.textContent || '#';
        const li = document.createElement('li');
        li.innerHTML = `<a href="${link}" target="_blank" rel="noopener">${title}</a>`;
        ul.appendChild(li);
      }});
      if(!ul.children.length){ ul.innerHTML = '<li class="muted">Keine Items</li>'; }
    }catch(e){ $('#newsList').innerHTML = '<li class="muted">Fehler beim Laden</li>'; }
  }

  // ===== Settings UI
  function openSettings(){
    const modal = $('#settingsModal');
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    document.body.classList.add('modal-open');
    rebuildSettingsPanels();
    fillSettings();
    bgRenderSettings();
    initSettingsTabs();
    const last = store.get('settings.tab','general');
    selectSettingsTab(last);
  }
  function closeSettings(){
    const modal = $('#settingsModal');
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
  }
  function fillSettings(){
    const theme = store.get('theme','auto');
    $('#themeSelect').value = theme;
    $('#defaultCity').value = store.get('weather.city','Hannover');

    // Engines
    const pills = $('#enginePills'); pills.innerHTML='';
    Object.keys(ENGINES).forEach(key=>{
      const on = (store.get('engines.enabled', Object.keys(ENGINES))).includes(key);
      const pill = document.createElement('button');
      pill.className='btn'; pill.textContent = key + (on?' ✓':' ✕');
      pill.addEventListener('click', ()=>{
        let enabled = store.get('engines.enabled', Object.keys(ENGINES));
        if(on) enabled = enabled.filter(e=>e!==key); else enabled = Array.from(new Set([...enabled, key]));
        store.set('engines.enabled', enabled);
        fillSettings(); renderEngines();
      });
      pills.appendChild(pill);
    });

    // Shortcuts
    $('#shortcutConfig').value = JSON.stringify(getShortcuts(), null, 2);

    // Feeds
    $('#feedsConfig').value = JSON.stringify(store.get('news.custom', {}), null, 2);

    // Widgets toggle list
    const defaults = widgetDefaults();
    const conf = store.get('widgets', defaults);
    const wrap = $('#widgetToggles'); wrap.innerHTML='';
    Object.keys(defaults).forEach(k=>{
      const id = `w_${k}`;
      const label = document.createElement('label'); label.style.display='inline-flex'; label.style.alignItems='center'; label.style.gap='6px';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.checked = conf[k];
      cb.addEventListener('change', ()=>{ const cur=store.get('widgets', defaults); cur[k]=cb.checked; store.set('widgets', cur); applyWidgets(); });
      label.appendChild(cb); label.appendChild(document.createTextNode(k));
      wrap.appendChild(label);
    });

    // Widget colors editor
    const editor = $('#widgetColorEditor'); editor.innerHTML='';
    const names = { todo:'To‑Do', notes:'Notizen', tiles:'Favoriten', weather:'Wetter', quote:'Quote', recent:'Zuletzt', system:'System', news:'News' };
    const colors = store.get('widget.colors', widgetColorDefaults());
    Object.keys(names).forEach(k=>{
      const box = document.createElement('div'); box.style.display='inline-flex'; box.style.alignItems='center'; box.style.gap='6px'; box.style.padding='6px 8px'; box.style.background='var(--glass)'; box.style.border='1px solid rgba(255,255,255,.08)'; box.style.borderRadius='10px';
      const label = document.createElement('span'); label.textContent = names[k];
      const input = document.createElement('input'); input.type='color'; input.value = (colors[k] && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(colors[k])) ? colors[k] : '#7c5cff';
      input.addEventListener('input', ()=>{ const cur = store.get('widget.colors', widgetColorDefaults()); cur[k]=input.value; store.set('widget.colors', cur); applyWidgetColors(); });
      const clear = document.createElement('button'); clear.className='btn'; clear.textContent='Reset';
      clear.addEventListener('click', ()=>{ const cur = store.get('widget.colors', widgetColorDefaults()); cur[k]=''; store.set('widget.colors', cur); applyWidgetColors(); fillSettings(); });
      box.appendChild(label); box.appendChild(input); box.appendChild(clear);
      editor.appendChild(box);
    });

    const cardStyle = store.get('ui.cardStyle', 'glass');
    const styleSelect = $('#cardStyle'); if(styleSelect) styleSelect.value = ['glass','solid','transparent','minimal'].includes(cardStyle) ? cardStyle : 'glass';

    const clockInput = $('#clockColor'); if(clockInput){
      const value = store.get('ui.clock.color','');
      clockInput.value = value && /^#([0-9a-f]{6})$/i.test(value) ? value : '#7c5cff';
    }
    const searchInput = $('#searchColor'); if(searchInput){
      const value = store.get('ui.search.color','');
      searchInput.value = value && /^#([0-9a-f]{6})$/i.test(value) ? value : '#54d6ff';
    }
  }

  function selectSettingsTab(name){
    const valid = ['general','background','search','widgets','data','guide'];
    if(!valid.includes(name)) name = 'general';
    const buttons = $$('.tab-btn', $('#settingsModal'));
    const panels = [
      {n:'general', el: $('#tab-general')},
      {n:'background', el: $('#tab-background')},
      {n:'search', el: $('#tab-search')},
      {n:'widgets', el: $('#tab-widgets')},
      {n:'data', el: $('#tab-data')},
      {n:'guide', el: $('#tab-guide')},
    ];
    buttons.forEach(b=>{ const on = b.getAttribute('data-tab')===name; b.classList.toggle('active', on); b.setAttribute('aria-selected', on?'true':'false'); });
    panels.forEach(p=>{ if(p.el) p.el.classList.toggle('active', p.n===name); });
    store.set('settings.tab', name);
    if(name === 'background') bgRenderSettings();
  }
  function initSettingsTabs(){
    const root = $('#settingsModal'); if(!root) return;
    $$('.tab-btn', root).forEach(btn=>{
      btn.addEventListener('click', ()=> selectSettingsTab(btn.getAttribute('data-tab')));
    });
  }

  // Make sure tabs contain the right rows regardless of initial HTML structure
  function rebuildSettingsPanels(){
    const sheet = $('#settingsModal .sheet'); if(!sheet) return;
    const tabs = sheet.querySelector('.tabs'); if(!tabs) return;
    // Collect rows from root and any pre-existing panels BEFORE removing them
    const rows = Array.from(sheet.querySelectorAll(':scope > .row, :scope > .tab-panel > .row'));
    // Remove old panels
    sheet.querySelectorAll(':scope > .tab-panel').forEach(p=> p.remove());

    const panelGeneral = document.createElement('div'); panelGeneral.id='tab-general'; panelGeneral.className='tab-panel';
    const panelBackground = document.createElement('div'); panelBackground.id='tab-background'; panelBackground.className='tab-panel';
    const panelSearch = document.createElement('div'); panelSearch.id='tab-search'; panelSearch.className='tab-panel';
    const panelWidgets = document.createElement('div'); panelWidgets.id='tab-widgets'; panelWidgets.className='tab-panel';
    const panelData = document.createElement('div'); panelData.id='tab-data'; panelData.className='tab-panel';
    const panelGuide = document.createElement('div'); panelGuide.id='tab-guide'; panelGuide.className='tab-panel';

    const assign = (row, target)=>{ if(!row) return; if(row.parentElement) row.parentElement.removeChild(row); target.appendChild(row); };
    rows.forEach(row=>{
      const has = sel => row.querySelector(sel);
      if(has('#themeSelect')) assign(row, panelGeneral);
      else if(has('#bgEngine')) assign(row, panelBackground);
      else if(has('#enginePills') || has('#shortcutConfig') || has('#feedsConfig')) assign(row, panelSearch);
      else if(has('#widgetToggles') || has('#widgetColorEditor') || has('#cardStyle') || has('#clockColor') || has('#searchColor') || has('#defaultCity')) assign(row, panelWidgets);
      else if(has('#exportData') || has('#importData') || has('#dataNote')) assign(row, panelData);
      else assign(row, panelGeneral);
    });

    // Build static guide content
    panelGuide.innerHTML = `
      <div class="row"><label>User Guide</label>
        <div>
          <h5>Overview</h5>
          <ul>
            <li>Startseite mit Suche, Favoriten, To-Do, Notizen, Wetter, News.</li>
            <li>Alles lokal: Daten bleiben im Browser (localStorage).</li>
          </ul>
          <h5>Shortcuts</h5>
          <ul>
            <li>Ctrl/Cmd+K: Command Palette öffnen</li>
            <li>1–9: Erste 9 Favoriten öffnen (wenn nicht tippen)</li>
            <li>/ : Suche fokussieren (über Palette auswählbar)</li>
            <li>Enter in Suche: Startet die Suche</li>
            <li>ESC: Modals schließen</li>
            <li>Palette: Taste C wechselt den Kachel-Stil, "Header-Farben zurücksetzen" stellt Suche & Uhr zurück</li>
          </ul>
          <h5>Suche & Bangs</h5>
          <ul>
            <li>Bangs: !g !ddg !bing !yt !wiki !maps</li>
            <li>Eigene Shortcuts: JSON in den Einstellungen; {q} als Platzhalter</li>
          </ul>
          <h5>Tiles</h5>
          <ul>
            <li>Drag&Drop zum Sortieren, Klick zum Öffnen</li>
            <li>+ Kachel: Neue Favoriten hinzufügen</li>
            <li>Reset: Standardfavoriten wiederherstellen</li>
          </ul>
          <h5>Widgets & Layout</h5>
          <ul>
            <li>Sichtbarkeit je Widget umschaltbar</li>
            <li>Kachel-Stil global anpassbar (Glas, Vollfläche, Transparent, Soft Minimal)</li>
            <li>Eigenes Farbschema für Zeit/Datum und Suche; Reset bringt Stilvorgabe zurück</li>
            <li>Widget-Farben: Eigene Akzenttöne je Kachel möglich</li>
          </ul>
          <h5>Daten</h5>
          <ul>
            <li>Export/Import als JSON</li>
          </ul>
        </div>
      </div>`;

    tabs.insertAdjacentElement('afterend', panelGeneral);
    panelGeneral.insertAdjacentElement('afterend', panelBackground);
    panelBackground.insertAdjacentElement('afterend', panelSearch);
    panelSearch.insertAdjacentElement('afterend', panelWidgets);

    panelWidgets.insertAdjacentElement('afterend', panelData);
    panelData.insertAdjacentElement('afterend', panelGuide);

    // Activate default panel before selectSettingsTab runs
    panelGeneral.classList.add('active');
  }
  function renderEngines(){
    const enabled = store.get('engines.enabled', Object.keys(ENGINES));
    const select = $('#engine');
    const current = select.value;
    select.innerHTML = '';
    enabled.forEach(k=>{
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = ({google:'Google',ddg:'DuckDuckGo',bing:'Bing',yt:'YouTube',wikipedia:'Wikipedia',maps:'Google Maps'})[k]||k;
      select.appendChild(opt);
    });
    if(enabled.includes(current)) select.value = current; else select.value = enabled[0];
  }

  // ===== Background engine
  
  const BG_PRESETS = [
    {
      id: 'aurora',
      label: 'Aurora Ridge',
      url: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1920&q=80',
      tone: 'dark',
      tags: ['night', 'nature'],
      credit: 'Photo: Joshua Earle - Unsplash'
    },
    {
      id: 'city-neon',
      label: 'Neon City',
      url: 'https://images.unsplash.com/photo-1499346030926-9a72daac6c63?auto=format&fit=crop&w=1920&q=80',
      tone: 'dark',
      tags: ['city', 'urban'],
      credit: 'Photo: Denys Nevozhai - Unsplash'
    },
    {
      id: 'mountain-dawn',
      label: 'Mountain Dawn',
      url: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1920&q=80',
      tone: 'light',
      tags: ['mountain', 'sunrise'],
      credit: 'Photo: Nathan Anderson - Unsplash'
    },
    {
      id: 'forest-mist',
      label: 'Forest Mist',
      url: 'https://images.unsplash.com/photo-1470770841072-f978cf4d019e?auto=format&fit=crop&w=1920&q=80',
      tone: 'neutral',
      tags: ['forest', 'mist'],
      credit: 'Photo: Julia Caesar - Unsplash'
    },
    {
      id: 'ocean-calm',
      label: 'Ocean Calm',
      url: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1920&q=80',
      tone: 'light',
      tags: ['ocean', 'blue'],
      credit: 'Photo: Fabian Wiktor - Unsplash'
    }
  ];
  const BG_TIME_SLOTS = [
    { id: 'morning', label: 'Morning 05-11' },
    { id: 'day', label: 'Day 11-17' },
    { id: 'evening', label: 'Evening 17-21' },
    { id: 'night', label: 'Night 21-05' }
  ];
  const BG_MAX_UPLOADS = 8;
  let bgRotationTimer = null;

  function bgCloneRef(ref){
    return ref ? JSON.parse(JSON.stringify(ref)) : null;
  }

  function bgCssBg(url){
    if(!url) return '';
    const safe = String(url).replace(/'/g, "\'");
    return "background-image:url('" + safe + "')";
  }

function bgDefaultState(){
    const makePreset = index => BG_PRESETS[index] ? { type: 'preset', id: BG_PRESETS[index].id } : null;
    const first = makePreset(0);
    const fallback = first ? bgCloneRef(first) : { type: 'custom', url: '' };
    const morning = makePreset(2) || (first ? bgCloneRef(first) : null);
    const day = makePreset(3) || (first ? bgCloneRef(first) : null);
    const evening = makePreset(1) || (first ? bgCloneRef(first) : null);
    const night = makePreset(0) || makePreset(1) || bgCloneRef(fallback);
    return {
      active: first ? bgCloneRef(first) : bgCloneRef(fallback),
      customUrl: '',
      uploads: [],
      favorites: first ? [bgCloneRef(first)] : [],
      collections: [],
      history: [],
      rotation: {
        enabled: false,
        strategy: 'time',
        intervalMinutes: 90,
        locked: false,
        lastApplied: 0,
        sources: { presets: true, favorites: true, uploads: true, collections: true, custom: true },
        schedule: {
          morning: morning ? bgCloneRef(morning) : bgCloneRef(fallback),
          day: day ? bgCloneRef(day) : bgCloneRef(fallback),
          evening: evening ? bgCloneRef(evening) : bgCloneRef(fallback),
          night: night ? bgCloneRef(night) : bgCloneRef(fallback),
          light: day ? bgCloneRef(day) : bgCloneRef(fallback),
          dark: night ? bgCloneRef(night) : bgCloneRef(fallback)
        }
      },
      ui: { tab: 'presets' }
    };
  }

  function bgNormalizeState(raw){
    const base = bgDefaultState();
    if(!raw || typeof raw !== 'object') return base;
    const state = { ...base, ...raw };
    state.customUrl = typeof raw.customUrl === 'string' ? raw.customUrl.trim() : '';
    state.uploads = Array.isArray(raw.uploads) ? raw.uploads.filter(Boolean).map(u => ({
      id: String(u.id || 'upload-' + Date.now()),
      name: typeof u.name === 'string' ? u.name : 'Upload',
      dataUrl: typeof u.dataUrl === 'string' ? u.dataUrl : '',
      width: Number(u.width) || 0,
      height: Number(u.height) || 0,
      created: Number(u.created) || Date.now()
    })).filter(u => u.dataUrl).slice(0, BG_MAX_UPLOADS) : [];
    state.favorites = Array.isArray(raw.favorites) ? raw.favorites.map(bgCloneRef).filter(Boolean).slice(0, 32) : base.favorites;
    state.collections = Array.isArray(raw.collections) ? raw.collections.map(col => ({
      id: String(col.id || 'col-' + Math.random().toString(36).slice(2,8)),
      name: typeof col.name === 'string' && col.name.trim() ? col.name.trim() : 'Collection',
      urls: Array.isArray(col.urls) ? col.urls.map(String).map(u => u.trim()).filter(Boolean).slice(0, 40) : [],
      cache: col.cache && typeof col.cache === 'object' ? col.cache : {},
      allowRotation: col.allowRotation !== false,
      created: Number(col.created) || Date.now(),
      updated: Number(col.updated) || Date.now()
    })).filter(col => col.urls.length).slice(0, 12) : [];
    state.history = Array.isArray(raw.history) ? raw.history.map(bgCloneRef).filter(Boolean).slice(0, 20) : [];
    const rotationRaw = raw.rotation && typeof raw.rotation === 'object' ? raw.rotation : {};
    state.rotation = {
      ...base.rotation,
      ...rotationRaw,
      intervalMinutes: Number(rotationRaw.intervalMinutes) || base.rotation.intervalMinutes,
      sources: { ...base.rotation.sources, ...(rotationRaw.sources || {}) },
      schedule: { ...base.rotation.schedule }
    };
    if(rotationRaw.schedule && typeof rotationRaw.schedule === 'object'){
      Object.keys(rotationRaw.schedule).forEach(key => {
        state.rotation.schedule[key] = rotationRaw.schedule[key] ? bgCloneRef(rotationRaw.schedule[key]) : null;
      });
    }
    if(rotationRaw.locked === true || rotationRaw.locked === false) state.rotation.locked = rotationRaw.locked;
    state.active = raw.active ? bgCloneRef(raw.active) : base.active;
    if(!state.active) state.active = base.active;
    state.ui = {
      tab: raw.ui && typeof raw.ui === 'object' && typeof raw.ui.tab === 'string' ? raw.ui.tab : base.ui.tab
    };
    return state;
  }

  function bgLoadState(){
    const raw = store.get('bg.state', null);
    if(raw) return bgNormalizeState(raw);
    const legacy = store.get('bg.url', '');
    if(legacy){
      try { localStorage.removeItem('bg.url'); } catch (err) {}
      const base = bgDefaultState();
      base.customUrl = legacy;
      base.active = { type: 'custom', url: legacy };
      return base;
    }
    return bgDefaultState();
  }

  function bgSaveState(state){
    store.set('bg.state', bgNormalizeState(state));
  }

  function bgUpdateState(mutator){
    const state = bgLoadState();
    const next = mutator ? mutator(state) || state : state;
    const normalized = bgNormalizeState(next);
    bgSaveState(normalized);
    return normalized;
  }

  function bgEncodeRef(ref){
    if(!ref || !ref.type) return '';
    if(ref.type === 'preset') return 'preset::' + (ref.id || '');
    if(ref.type === 'upload') return 'upload::' + (ref.id || '');
    if(ref.type === 'collection') return 'collection::' + (ref.collectionId || '') + '::' + encodeURIComponent(ref.url || '');
    if(ref.type === 'custom') return 'custom::' + encodeURIComponent(ref.url || '');
    return '';
  }

  function bgDecodeRef(token){
    if(!token) return null;
    const parts = token.split('::');
    const type = parts[0];
    if(type === 'preset') return { type: 'preset', id: parts[1] || '' };
    if(type === 'upload') return { type: 'upload', id: parts[1] || '' };
    if(type === 'collection') return { type: 'collection', collectionId: parts[1] || '', url: decodeURIComponent(parts[2] || '') };
    if(type === 'custom') return { type: 'custom', url: decodeURIComponent(parts[1] || '') };
    return null;
  }

  function bgRefKey(ref){
    return bgEncodeRef(ref);
  }

  function bgResolveRef(state, ref){
    if(!ref || !ref.type) return null;
    if(ref.type === 'preset'){
      const preset = BG_PRESETS.find(p => p.id === ref.id);
      if(!preset) return null;
      return {
        ref: { type: 'preset', id: preset.id },
        url: preset.url,
        title: preset.label,
        subtitle: 'Preset',
        meta: preset.tags && preset.tags.length ? preset.tags.join(', ') : '',
        credit: preset.credit || ''
      };
    }
    if(ref.type === 'upload'){
      const upload = (state.uploads || []).find(u => u.id === ref.id);
      if(!upload) return null;
      return {
        ref: { type: 'upload', id: upload.id },
        url: upload.dataUrl,
        title: upload.name || 'Upload',
        subtitle: 'Upload',
        meta: upload.width && upload.height ? Math.round(upload.width) + 'x' + Math.round(upload.height) : ''
      };
    }
    if(ref.type === 'collection'){
      const collection = (state.collections || []).find(c => c.id === ref.collectionId);
      if(!collection || !collection.urls.length) return null;
      const url = ref.url || collection.urls[0];
      if(!url) return null;
      const cached = collection.cache && collection.cache[url];
      return {
        ref: { type: 'collection', collectionId: collection.id, url },
        url: cached || url,
        title: collection.name,
        subtitle: 'Collection',
        meta: url
      };
    }
    if(ref.type === 'custom'){
      const url = ref.url || state.customUrl;
      if(!url) return null;
      return {
        ref: { type: 'custom', url },
        url,
        title: 'Custom URL',
        subtitle: 'Custom',
        meta: url
      };
    }
    return null;
  }
  function bgApplyResolved(resolved, state){
    const body = document.body;
    if(!body) return;
    if(resolved && resolved.url){
      const safe = resolved.url.replace(/"/g, '\\"');
      body.style.backgroundImage = 'url("' + safe + '")';
      body.style.backgroundSize = 'cover';
      body.style.backgroundPosition = 'center';
      body.style.backgroundAttachment = 'fixed';
    } else {
      body.style.backgroundImage = '';
    }
    body.dataset.bgType = resolved ? resolved.ref.type : '';
  }

  function bgRenderPreview(state, resolved){
    const preview = document.getElementById('bgCurrentPreview');
    if(preview){
      preview.style.backgroundImage = resolved && resolved.url ? 'url("' + resolved.url.replace(/"/g, '\\"') + '")' : '';
    }
    const title = document.getElementById('bgCurrentTitle');
    if(title) title.textContent = resolved ? resolved.title : 'Kein Hintergrund';
    const meta = document.getElementById('bgCurrentMeta');
    if(meta){
      const parts = [];
      if(resolved){
        if(resolved.subtitle) parts.push(resolved.subtitle);
        if(resolved.meta) parts.push(resolved.meta);
        if(resolved.credit) parts.push(resolved.credit);
      }
      meta.textContent = parts.length ? parts.join(' | ') : 'Kein Bild ausgewaehlt';
    }
    const undoBtn = document.getElementById('bgActionUndo');
    if(undoBtn) undoBtn.disabled = !(state.history && state.history.length);
    const lockBtn = document.getElementById('bgActionLock');
    if(lockBtn){
      lockBtn.textContent = state.rotation && state.rotation.locked ? 'Rotation fortsetzen' : 'Rotation sperren';
      lockBtn.dataset.locked = state.rotation && state.rotation.locked ? 'true' : 'false';
    }
  }

  function bgRenderPresets(state){
    const panel = document.getElementById('bgPanel-presets');
    if(!panel) return;
    if(!BG_PRESETS.length){
      panel.innerHTML = '<div class="bg-empty">Keine Presets vorhanden.</div>';
      return;
    }
    const favKeys = new Set((state.favorites || []).map(bgRefKey));
    const activeKey = bgRefKey(state.active);
    const cards = BG_PRESETS.map(p => {
      const ref = { type: 'preset', id: p.id };
      const key = bgRefKey(ref);
      const isActive = key && key === activeKey;
      const isFav = favKeys.has(key);
      const metaParts = [];
      if(p.tags && p.tags.length) metaParts.push(p.tags.join(', '));
      if(p.tone) metaParts.push('Tone: ' + p.tone);
      const meta = metaParts.join(' | ');
      return '<div class="bg-card' + (isActive ? ' highlight' : '') + '" data-ref="' + key + '">' +
        '<div class="bg-thumb" style="' + bgCssBg(p.url) + '"></div>' +
        '<div class="bg-card-title">' + escapeHtml(p.label) + '</div>' +
        '<div class="bg-card-meta">' + (meta ? escapeHtml(meta) : '') + '</div>' +
        '<div class="bg-card-actions">' +
          '<button type="button" data-action="bg-apply" data-ref="' + key + '"' + (isActive ? ' data-active="true"' : '') + '>Setzen</button>' +
          '<button type="button" data-action="bg-favorite" data-ref="' + key + '">' + (isFav ? 'Favorit' : 'Favorisieren') + '</button>' +
        '</div>' +
      '</div>';
    }).join('');
    panel.innerHTML = '<div class="bg-grid">' + cards + '</div>';
  }

  function bgRenderFavorites(state){
    const panel = document.getElementById('bgPanel-favorites');
    if(!panel) return;
    if(!state.favorites.length){
      panel.innerHTML = '<div class="bg-empty">Noch keine Favoriten. Markiere Presets oder Uploads.</div>';
      return;
    }
    const activeKey = bgRefKey(state.active);
    const cards = state.favorites.map(ref => {
      const resolved = bgResolveRef(state, ref);
      if(!resolved) return '';
      const key = bgRefKey(resolved.ref);
      const isActive = key === activeKey;
      return '<div class="bg-card' + (isActive ? ' highlight' : '') + '" data-ref="' + key + '">' +
        '<div class="bg-thumb" style="' + bgCssBg(resolved.url) + '"></div>' +
        '<div class="bg-card-title">' + escapeHtml(resolved.title) + '</div>' +
        '<div class="bg-card-meta">' + (resolved.meta ? escapeHtml(resolved.meta) : '') + '</div>' +
        '<div class="bg-card-actions">' +
          '<button type="button" data-action="bg-apply" data-ref="' + key + '"' + (isActive ? ' data-active="true"' : '') + '>Setzen</button>' +
          '<button type="button" data-action="bg-favorite-remove" data-ref="' + key + '">Entfernen</button>' +
        '</div>' +
      '</div>';
    }).filter(Boolean).join('');
    panel.innerHTML = '<div class="bg-grid">' + cards + '</div>';
  }

  function bgRenderUploads(state){
    const panel = document.getElementById('bgPanel-uploads');
    if(!panel) return;
    const activeKey = bgRefKey(state.active);
    const list = (state.uploads || []).map(upload => {
      const ref = { type: 'upload', id: upload.id };
      const key = bgRefKey(ref);
      const isActive = key === activeKey;
      const size = upload.width && upload.height ? Math.round(upload.width) + 'x' + Math.round(upload.height) : '';
      return '<div class="bg-card' + (isActive ? ' highlight' : '') + '">' +
        '<div class="bg-thumb" style="' + bgCssBg(upload.dataUrl) + '"></div>' +
        '<div class="bg-card-title">' + escapeHtml(upload.name || 'Upload') + '</div>' +
        '<div class="bg-card-meta">' + escapeHtml(size) + '</div>' +
        '<div class="bg-card-actions">' +
          '<button type="button" data-action="bg-apply" data-ref="' + key + '"' + (isActive ? ' data-active="true"' : '') + '>Setzen</button>' +
          '<button type="button" data-action="bg-favorite" data-ref="' + key + '">Favorisieren</button>' +
          '<button type="button" data-action="bg-delete-upload" data-upload="' + upload.id + '">Entfernen</button>' +
        '</div>' +
      '</div>';
    }).join('');
    panel.innerHTML =
      '<div class="bg-upload-drop" id="bgUploadDrop">' +
        '<div>Dateien hier ablegen</div>' +
        '<button type="button" data-action="bg-upload-browse">Datei auswählen</button>' +
        '<input type="file" id="bgUploadInput" multiple accept="image/*" hidden>' +
        '<div class="bg-upload-note">Wir verkleinern Bilder automatisch (16:9, max 2560px) und speichern sie lokal. Max ' + BG_MAX_UPLOADS + ' Dateien.</div>' +
      '</div>' +
      (state.uploads && state.uploads.length ? '<div class="bg-grid">' + list + '</div>' : '<div class="bg-empty">Noch keine Uploads vorhanden.</div>');
  }

  function bgRenderCollections(state){
    const panel = document.getElementById('bgPanel-collections');
    if(!panel) return;
    const cards = (state.collections || []).map(col => {
      const count = col.urls.length;
      const previewUrl = col.urls.length ? (col.cache && col.cache[col.urls[0]]) || col.urls[0] : '';
      return '<div class="bg-collection" data-collection="' + col.id + '">' +
        '<div class="bg-collection-header">' +
          '<div>' +
            '<div class="bg-collection-title">' + escapeHtml(col.name) + '</div>' +
            '<div class="bg-collection-count">' + count + ' Quellen</div>' +
          '</div>' +
          '<div class="bg-collection-actions">' +
            '<button type="button" data-action="bg-collection-apply" data-collection="' + col.id + '">Zufaellig</button>' +
            '<button type="button" data-action="bg-collection-cache" data-collection="' + col.id + '">Offline speichern</button>' +
            '<button type="button" data-action="bg-collection-remove" data-collection="' + col.id + '">Entfernen</button>' +
          '</div>' +
        '</div>' +
        (previewUrl ? '<div class="bg-thumb" style="' + bgCssBg(previewUrl) + '"></div>' : '') +
        '<details>' +
          '<summary>Quellen ansehen</summary>' +
          '<ul>' + col.urls.map(u => '<li><code>' + escapeHtml(u) + '</code></li>').join('') + '</ul>' +
          '<label style="display:inline-flex;align-items:center;gap:6px;margin-top:8px;">' +
            '<input type="checkbox" data-action="bg-collection-rotation" data-collection="' + col.id + '"' + (col.allowRotation !== false ? ' checked' : '') + '> Rotation verwenden' +
          '</label>' +
        '</details>' +
      '</div>';
    }).join('');
    panel.innerHTML =
      '<div class="bg-selector">' +
        '<label for="bgCollectionName">Neue Sammlung</label>' +
        '<input id="bgCollectionName" type="text" placeholder="Meine Sammlung">' +
        '<textarea id="bgCollectionUrls" rows="4" placeholder="Eine Bild-URL pro Zeile"></textarea>' +
        '<div class="bg-inline-actions">' +
          '<button type="button" data-action="bg-collection-save">Speichern</button>' +
          '<button type="button" data-action="bg-collection-clear">Felder leeren</button>' +
        '</div>' +
        '<p class="bg-mini-text">URLs werden lokal gespeichert. Remote Quellen benoetigen CORS fuer Bilder.</p>' +
      '</div>' +
      (cards ? '<div class="bg-collection-list">' + cards + '</div>' : '<div class="bg-empty">Noch keine Sammlungen angelegt.</div>');
  }

  function bgBuildRotationOptions(state){
    const options = [];
    const seen = new Set();
    const add = (label, ref) => {
      const key = bgRefKey(ref);
      if(!key || seen.has(key)) return;
      seen.add(key);
      options.push({ value: key, label });
    };
    BG_PRESETS.forEach(p => add('Preset: ' + p.label, { type: 'preset', id: p.id }));
    (state.uploads || []).forEach(u => add('Upload: ' + (u.name || u.id), { type: 'upload', id: u.id }));
    (state.favorites || []).forEach(f => {
      const resolved = bgResolveRef(state, f);
      add('Favorit: ' + (resolved ? resolved.title : bgRefKey(f)), f);
    });
    if(state.customUrl) add('Custom: gespeicherte URL', { type: 'custom', url: state.customUrl });
    return options;
  }

  function bgRenderRotation(state){
    const panel = document.getElementById('bgPanel-rotation');
    if(!panel) return;
    const options = bgBuildRotationOptions(state);
    const schedule = state.rotation.schedule || {};
    const buildSelect = slot => {
      const selected = schedule[slot] ? bgRefKey(schedule[slot]) : '';
      const opts = ['<option value="">Kein festes Bild</option>']
        .concat(options.map(opt => '<option value="' + opt.value + '"' + (opt.value === selected ? ' selected' : '') + '>' + escapeHtml(opt.label) + '</option>'))
        .join('');
      return '<select data-action="bg-rotation-slot" data-slot="' + slot + '">' + opts + '</select>';
    };
    const sources = state.rotation.sources || {};
    const sourceControls = [
      { key: 'presets', label: 'Presets' },
      { key: 'favorites', label: 'Favoriten' },
      { key: 'uploads', label: 'Uploads' },
      { key: 'collections', label: 'Sammlungen' },
      { key: 'custom', label: 'Custom URL' }
    ].map(item => '<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-action="bg-rotation-source" data-source="' + item.key + '"' + (sources[item.key] ? ' checked' : '') + '> ' + item.label + '</label>').join('');
    panel.innerHTML =
      '<div class="bg-rotation-grid">' +
        '<div class="bg-rotation-card">' +
          '<label><input type="checkbox" id="bgRotationEnabled"' + (state.rotation.enabled ? ' checked' : '') + '> Automatische Rotation aktiv</label>' +
          '<div class="bg-mini-text">' + (state.rotation.locked ? 'Rotation ist aktuell gesperrt.' : 'Hintergruende wechseln nach dem Plan.') + '</div>' +
          '<div class="bg-selector">' +
            '<label for="bgRotationStrategy">Modus</label>' +
            '<select id="bgRotationStrategy">' +
              '<option value="time"' + (state.rotation.strategy === 'time' ? ' selected' : '') + '>Zeitabhaengig</option>' +
              '<option value="interval"' + (state.rotation.strategy === 'interval' ? ' selected' : '') + '>Intervall</option>' +
              '<option value="theme"' + (state.rotation.strategy === 'theme' ? ' selected' : '') + '>Theme</option>' +
            '</select>' +
          '</div>' +
          '<div class="bg-selector">' +
            '<label for="bgRotationInterval">Intervall in Minuten</label>' +
            '<input id="bgRotationInterval" type="number" min="5" step="5" value="' + (Number(state.rotation.intervalMinutes) || 60) + '">' +
            '<div class="bg-mini-text">Relevanz nur im Intervall Modus.</div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-rotation-card">' +
          '<label>Quellen fuer Zufall</label>' +
          '<div class="bg-selector">' + sourceControls + '</div>' +
        '</div>' +
        '<div class="bg-rotation-card">' +
          '<label>Zeitplan</label>' +
          BG_TIME_SLOTS.map(slot => '<div class="bg-selector"><span>' + slot.label + '</span>' + buildSelect(slot.id) + '</div>').join('') +
        '</div>' +
        '<div class="bg-rotation-card">' +
          '<label>Theme Plan</label>' +
          '<div class="bg-selector"><span>Theme Light</span>' + buildSelect('light') + '</div>' +
          '<div class="bg-selector"><span>Theme Dark</span>' + buildSelect('dark') + '</div>' +
          '<div class="bg-mini-text">Theme Plan wird genutzt, wenn der Modus auf Theme steht.</div>' +
        '</div>' +
      '</div>';
  }

  function bgRenderCustom(state){
    const panel = document.getElementById('bgPanel-custom');
    if(!panel) return;
    panel.innerHTML =
      '<div class="bg-selector">' +
        '<label for="bgCustomUrl">Eigene Bild URL</label>' +
        '<input id="bgCustomUrl" type="url" placeholder="https://example.com/image.jpg" value="' + escapeHtml(state.customUrl || '') + '">' +
        '<div class="bg-inline-actions">' +
          '<button type="button" data-action="bg-custom-apply">Setzen</button>' +
          '<button type="button" data-action="bg-custom-save">Speichern</button>' +
          (state.customUrl ? '<button type="button" data-action="bg-custom-clear">Löschen</button>' : '') +
        '</div>' +
        '<p class="bg-mini-text">URL wird lokal gespeichert. Server muss CORS fuer Bilder erlauben.</p>' +
      '</div>';
  }

  function bgBindUploadInput(){
    const input = document.getElementById('bgUploadInput');
    if(input && !input.dataset.bound){
      input.addEventListener('change', event => {
        const files = Array.from(event.target.files || []);
        bgHandleFiles(files);
        input.value = '';
      });
      input.dataset.bound = 'true';
    }
  }

  function bgRenderSettings(){
    const engine = document.getElementById('bgEngine');
    if(!engine) return;
    const state = bgLoadState();
    const resolved = bgResolveRef(state, state.active);
    bgRenderPreview(state, resolved);
    bgRenderPresets(state);
    bgRenderFavorites(state);
    bgRenderUploads(state);
    bgRenderCollections(state);
    bgRenderRotation(state);
    bgRenderCustom(state);
    bgSetActiveTab((state.ui && state.ui.tab) || 'presets', false);
    bgBindUploadInput();
  }

  function bgSetActiveTab(name, persist){
    const engine = document.getElementById('bgEngine');
    if(!engine) return;
    engine.querySelectorAll('.bg-tab').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.panel === name);
    });
    engine.querySelectorAll('.bg-panel').forEach(panel => {
      panel.classList.toggle('active', panel.id === 'bgPanel-' + name);
    });
    if(persist){
      bgUpdateState(state => {
        if(!state.ui) state.ui = { tab: name };
        else state.ui.tab = name;
        return state;
      });
    }
  }
  function bgApply(ref, options){
    const opts = options || {};
    if(!ref){
      const state = bgLoadState();
      const resolved = bgResolveRef(state, state.active);
      bgApplyResolved(resolved, state);
      bgRenderPreview(state, resolved);
      return resolved;
    }
    let resolved = null;
    const state = bgUpdateState(current => {
      const candidate = bgResolveRef(current, ref);
      if(!candidate) return current;
      resolved = candidate;
      const currentKey = bgRefKey(current.active);
      const nextKey = bgRefKey(candidate.ref);
      if(!opts.skipHistory && currentKey && nextKey && currentKey !== nextKey){
        current.history = [bgCloneRef(current.active), ...(current.history || [])].filter(Boolean).slice(0, 20);
      }
      current.active = bgCloneRef(candidate.ref);
      current.rotation.lastApplied = Date.now();
      return current;
    });
    if(resolved) bgApplyResolved(resolved, state);
    bgRenderSettings();
    if(!opts.skipSchedule) bgRestartTimer(state);
    return resolved;
  }

  function bgToggleFavorite(ref){
    if(!ref) return;
    const key = bgRefKey(ref);
    bgUpdateState(state => {
      const list = state.favorites || [];
      const index = list.findIndex(item => bgRefKey(item) === key);
      if(index >= 0) list.splice(index, 1);
      else list.unshift(bgCloneRef(ref));
      state.favorites = list.slice(0, 32);
      return state;
    });
    bgRenderSettings();
  }

  function bgRemoveFavorite(ref){
    if(!ref) return;
    const key = bgRefKey(ref);
    bgUpdateState(state => {
      state.favorites = (state.favorites || []).filter(item => bgRefKey(item) !== key);
      return state;
    });
    bgRenderSettings();
  }

  function bgDeleteUpload(id){
    if(!id) return;
    let removedActive = false;
    bgUpdateState(state => {
      state.uploads = (state.uploads || []).filter(u => u.id !== id);
      state.history = (state.history || []).filter(r => !(r && r.type === 'upload' && r.id === id));
      if(state.active && state.active.type === 'upload' && state.active.id === id){
        removedActive = true;
        state.active = bgDefaultState().active;
      }
      return state;
    });
    if(removedActive) bgApply(null, { skipHistory: true });
    bgRenderSettings();
  }

  function bgSaveCollection(){
    const nameInput = document.getElementById('bgCollectionName');
    const urlsInput = document.getElementById('bgCollectionUrls');
    if(!urlsInput) return;
    const name = nameInput ? nameInput.value.trim() : '';
    const urls = urlsInput.value.split(/\r?\n/).map(v => v.trim()).filter(Boolean);
    if(!urls.length){
      alert('Mindestens eine URL eintragen.');
      return;
    }
    bgUpdateState(state => {
      const collection = {
        id: 'col-' + Date.now().toString(36),
        name: name || 'Sammlung ' + (state.collections.length + 1),
        urls,
        cache: {},
        allowRotation: true,
        created: Date.now(),
        updated: Date.now()
      };
      state.collections.unshift(collection);
      state.collections = state.collections.slice(0, 12);
      return state;
    });
    if(nameInput) nameInput.value = '';
    urlsInput.value = '';
    bgRenderSettings();
  }

  function bgClearCollectionForm(){
    const nameInput = document.getElementById('bgCollectionName');
    if(nameInput) nameInput.value = '';
    const urlsInput = document.getElementById('bgCollectionUrls');
    if(urlsInput) urlsInput.value = '';
  }

  function bgApplyCollection(id){
    const state = bgLoadState();
    const collection = state.collections.find(c => c.id === id);
    if(!collection || !collection.urls.length){
      alert('Sammlung ist leer.');
      return;
    }
    const options = collection.urls.map(url => ({ type: 'collection', collectionId: collection.id, url }));
    const pick = options[Math.floor(Math.random() * options.length)];
    bgApply(bgCloneRef(pick));
  }

  async function bgCacheCollection(id){
    const state = bgLoadState();
    const collection = state.collections.find(c => c.id === id);
    if(!collection || !collection.urls.length){
      alert('Sammlung ist leer.');
      return;
    }
    const button = document.querySelector('[data-action="bg-collection-cache"][data-collection="' + id + '"]');
    if(button) button.disabled = true;
    const cached = {};
    try {
      for(const url of collection.urls){
        const data = await bgFetchImageData(url);
        if(data) cached[url] = data;
      }
      bgUpdateState(stateUpdate => {
        const target = stateUpdate.collections.find(c => c.id === id);
        if(target){
          target.cache = { ...target.cache, ...cached };
          target.updated = Date.now();
        }
        return stateUpdate;
      });
      alert('Sammlung lokal gespeichert.');
    } catch (err) {
      console.error(err);
      alert('Fehler beim Laden. Pruefe CORS Vorgaben.');
    } finally {
      if(button) button.disabled = false;
    }
    bgRenderSettings();
  }

  function bgHandleCustom(action){
    const input = document.getElementById('bgCustomUrl');
    if(!input) return;
    const value = input.value.trim();
    if(action === 'save'){
      bgUpdateState(state => { state.customUrl = value; return state; });
      bgRenderSettings();
      return;
    }
    if(action === 'apply'){
      if(!value){
        alert('Bitte eine URL eintragen.');
        return;
      }
      bgUpdateState(state => { state.customUrl = value; return state; });
      bgApply({ type: 'custom', url: value });
      return;
    }
    if(action === 'clear'){
      bgUpdateState(state => {
        state.customUrl = '';
        state.history = (state.history || []).filter(ref => ref.type !== 'custom');
        if(state.active && state.active.type === 'custom') state.active = bgDefaultState().active;
        return state;
      });
      bgApply(null, { skipHistory: true });
      bgRenderSettings();
    }
  }

  function bgHandleClick(event){
    const target = event.target;
    if(!target) return;
    const tabBtn = target.closest('.bg-tab');
    if(tabBtn){
      bgSetActiveTab(tabBtn.dataset.panel, true);
      return;
    }
    const action = target.dataset.action;
    if(!action) return;
    if(action === 'bg-random'){
      bgRandomPick();
      return;
    }
    if(action === 'bg-undo'){
      bgUndo();
      return;
    }
    if(action === 'bg-lock'){
      bgToggleLock();
      return;
    }
    if(action === 'bg-apply'){
      const ref = bgDecodeRef(target.dataset.ref);
      if(ref) bgApply(ref);
      return;
    }
    if(action === 'bg-favorite'){
      const ref = bgDecodeRef(target.dataset.ref);
      if(ref) bgToggleFavorite(ref);
      return;
    }
    if(action === 'bg-favorite-remove'){
      const ref = bgDecodeRef(target.dataset.ref);
      if(ref) bgRemoveFavorite(ref);
      return;
    }
    if(action === 'bg-delete-upload'){
      bgDeleteUpload(target.dataset.upload);
      return;
    }
    if(action === 'bg-upload-browse'){
      const input = document.getElementById('bgUploadInput');
      if(input) input.click();
      return;
    }
    if(action === 'bg-collection-save'){
      bgSaveCollection();
      return;
    }
    if(action === 'bg-collection-clear'){
      bgClearCollectionForm();
      return;
    }
    if(action === 'bg-collection-apply'){
      bgApplyCollection(target.dataset.collection);
      return;
    }
    if(action === 'bg-collection-cache'){
      bgCacheCollection(target.dataset.collection);
      return;
    }
    if(action === 'bg-collection-remove'){
      const id = target.dataset.collection;
      bgUpdateState(state => {
        state.collections = (state.collections || []).filter(c => c.id !== id);
        state.history = (state.history || []).filter(ref => !(ref && ref.type === 'collection' && ref.collectionId === id));
        if(state.active && state.active.type === 'collection' && state.active.collectionId === id){
          state.active = bgDefaultState().active;
        }
        return state;
      });
      bgApply(null, { skipHistory: true });
      bgRenderSettings();
      return;
    }
    if(action === 'bg-custom-apply'){
      bgHandleCustom('apply');
      return;
    }
    if(action === 'bg-custom-save'){
      bgHandleCustom('save');
      return;
    }
    if(action === 'bg-custom-clear'){
      bgHandleCustom('clear');
      return;
    }
  }

  function bgHandleChange(event){
    const target = event.target;
    if(!target) return;
    if(target.id === 'bgRotationEnabled'){
      const checked = target.checked;
      const state = bgUpdateState(state => { state.rotation.enabled = checked; return state; });
      if(checked) bgEvaluateRotation('enabled');
      bgRestartTimer(state);
      bgRenderSettings();
      return;
    }
    if(target.id === 'bgRotationStrategy'){
      const strategy = target.value || 'time';
      const state = bgUpdateState(state => { state.rotation.strategy = strategy; return state; });
      bgEvaluateRotation('strategy');
      bgRestartTimer(state);
      bgRenderSettings();
      return;
    }
    if(target.id === 'bgRotationInterval'){
      const mins = Math.max(5, Number(target.value) || 5);
      const state = bgUpdateState(state => { state.rotation.intervalMinutes = mins; return state; });
      bgRestartTimer(state);
      bgRenderSettings();
      return;
    }
    const action = target.dataset.action;
    if(action === 'bg-rotation-source'){
      const key = target.dataset.source;
      bgUpdateState(state => {
        state.rotation.sources[key] = target.checked;
        return state;
      });
      bgRestartTimer(bgLoadState());
      return;
    }
    if(action === 'bg-rotation-slot'){
      const slot = target.dataset.slot;
      const token = target.value;
      bgUpdateState(state => {
        state.rotation.schedule[slot] = token ? bgCloneRef(bgDecodeRef(token)) : null;
        return state;
      });
      bgRenderSettings();
      bgEvaluateRotation('schedule');
      return;
    }
    if(action === 'bg-collection-rotation'){
      const id = target.dataset.collection;
      bgUpdateState(state => {
        const collection = (state.collections || []).find(c => c.id === id);
        if(collection) collection.allowRotation = target.checked;
        return state;
      });
    }
  }

  function bgHandleDrag(event){
    const drop = document.getElementById('bgUploadDrop');
    if(!drop) return;
    if(event.type === 'dragover'){
      event.preventDefault();
      drop.classList.add('dragging');
    } else if(event.type === 'dragleave'){
      drop.classList.remove('dragging');
    }
  }

  function bgHandleDrop(event){
    const drop = document.getElementById('bgUploadDrop');
    if(!drop) return;
    event.preventDefault();
    drop.classList.remove('dragging');
    const files = Array.from(event.dataTransfer && event.dataTransfer.files ? event.dataTransfer.files : []);
    if(files.length) bgHandleFiles(files);
  }
  async function bgHandleFiles(files){
    if(!files || !files.length) return;
    const queue = [];
    for(const file of files){
      if(queue.length >= BG_MAX_UPLOADS) break;
      if(file.type && !file.type.startsWith('image/')) continue;
      queue.push(file);
    }
    for(const file of queue){
      try {
        await bgProcessFile(file);
      } catch (err) {
        console.error(err);
      }
    }
    bgRenderSettings();
  }

  async function bgProcessFile(file){
    const dataUrl = await bgReadFileAsDataUrl(file);
    const img = await bgLoadImage(dataUrl);
    const scaled = bgResizeImage(img);
    const entry = {
      id: 'upload-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,6),
      name: file.name ? file.name.replace(/\.[^.]+$/, '') : 'Upload',
      dataUrl: scaled.dataUrl,
      width: scaled.width,
      height: scaled.height,
      created: Date.now()
    };
    bgUpdateState(state => {
      state.uploads.unshift(entry);
      state.uploads = state.uploads.slice(0, BG_MAX_UPLOADS);
      return state;
    });
  }

  function bgReadFileAsDataUrl(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(new Error('Lesen fehlgeschlagen'));
      reader.readAsDataURL(file);
    });
  }

  function bgLoadImage(dataUrl){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error('Bild konnte nicht geladen werden'));
      img.src = dataUrl;
    });
  }

  function bgResizeImage(img){
    const targetRatio = 16 / 9;
    const maxWidth = 2560;
    const maxHeight = 1440;
    let width = maxWidth;
    let height = Math.round(width / targetRatio);
    if(height > maxHeight){
      height = maxHeight;
      width = Math.round(height * targetRatio);
    }
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    if(!ctx){
      return { dataUrl: img.src, width: img.width, height: img.height };
    }
    const sourceRatio = img.width / img.height;
    let sx = 0, sy = 0, sw = img.width, sh = img.height;
    if(sourceRatio > targetRatio){
      sh = img.height;
      sw = sh * targetRatio;
      sx = (img.width - sw) / 2;
    } else {
      sw = img.width;
      sh = sw / targetRatio;
      sy = (img.height - sh) / 2;
    }
    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, width, height);
    let dataUrl;
    try {
      dataUrl = canvas.toDataURL('image/jpeg', 0.82);
    } catch (err) {
      dataUrl = img.src;
    }
    return { dataUrl, width, height };
  }

  function bgFetchImageData(url){
    return fetch(url, { mode: 'cors' })
      .then(res => {
        if(!res.ok) throw new Error('Fetch fehlgeschlagen');
        return res.blob();
      })
      .then(blob => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('Konvertierung fehlgeschlagen'));
        reader.readAsDataURL(blob);
      }));
  }

  function bgCollectCandidates(state, includeActive){
    const allow = state.rotation.sources || {};
    const list = [];
    const activeKey = bgRefKey(state.active);
    if(allow.presets){
      BG_PRESETS.forEach(p => list.push({ type: 'preset', id: p.id }));
    }
    if(allow.uploads){
      (state.uploads || []).forEach(u => list.push({ type: 'upload', id: u.id }));
    }
    if(allow.favorites){
      (state.favorites || []).forEach(f => list.push(bgCloneRef(f)));
    }
    if(allow.collections){
      (state.collections || []).forEach(col => {
        if(col.allowRotation === false) return;
        col.urls.forEach(url => list.push({ type: 'collection', collectionId: col.id, url }));
      });
    }
    if(allow.custom && state.customUrl){
      list.push({ type: 'custom', url: state.customUrl });
    }
    return list.filter(ref => {
      const key = bgRefKey(ref);
      if(!key) return false;
      if(!includeActive && key === activeKey) return false;
      return !!bgResolveRef(state, ref);
    });
  }

  function bgRandomPick(){
    const state = bgLoadState();
    const candidates = bgCollectCandidates(state, false);
    if(!candidates.length){
      alert('Keine Hintergruende verfuegbar.');
      return;
    }
    const pick = bgCloneRef(candidates[Math.floor(Math.random() * candidates.length)]);
    bgApply(pick);
  }

  function bgUndo(){
    let resolved = null;
    const state = bgUpdateState(current => {
      if(!current.history || !current.history.length) return current;
      const previous = current.history.shift();
      const candidate = bgResolveRef(current, previous);
      if(!candidate) return current;
      resolved = candidate;
      current.active = bgCloneRef(candidate.ref);
      return current;
    });
    if(resolved) bgApplyResolved(resolved, state);
    bgRenderSettings();
  }

  function bgToggleLock(){
    const state = bgUpdateState(current => {
      current.rotation.locked = !current.rotation.locked;
      return current;
    });
    if(state.rotation.locked && bgRotationTimer){
      clearTimeout(bgRotationTimer);
      bgRotationTimer = null;
    }
    if(!state.rotation.locked) bgEvaluateRotation('unlock');
    bgRenderSettings();
  }

  function bgGetEffectiveTheme(){
    const mode = store.get('theme', 'auto');
    if(mode === 'dark' || mode === 'light') return mode;
    return matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function bgCurrentSlot(){
    const hour = new Date().getHours();
    if(hour >= 5 && hour < 11) return 'morning';
    if(hour >= 11 && hour < 17) return 'day';
    if(hour >= 17 && hour < 21) return 'evening';
    return 'night';
  }

  function bgPickSlot(state){
    const schedule = state.rotation.schedule || {};
    const ref = schedule[bgCurrentSlot()];
    return ref ? bgCloneRef(ref) : null;
  }

  function bgPickTheme(state){
    const schedule = state.rotation.schedule || {};
    const theme = bgGetEffectiveTheme();
    return schedule[theme] ? bgCloneRef(schedule[theme]) : null;
  }

  function bgComputeDelay(state){
    if(state.rotation.strategy === 'interval'){
      const mins = Math.max(5, Number(state.rotation.intervalMinutes) || 60);
      return mins * 60000;
    }
    if(state.rotation.strategy === 'time'){
      const now = new Date();
      const hour = now.getHours();
      const minute = now.getMinutes();
      const checkpoints = [5, 11, 17, 21];
      let nextHour = checkpoints.find(h => h > hour || (h === hour && minute < 1));
      const target = new Date(now);
      if(nextHour === undefined){
        target.setDate(target.getDate() + 1);
        target.setHours(5, 0, 5, 0);
      } else {
        target.setHours(nextHour, 0, 5, 0);
      }
      const diff = target.getTime() - now.getTime();
      return Math.max(diff, 60000);
    }
    if(state.rotation.strategy === 'theme'){
      return 5 * 60000;
    }
    return null;
  }

  function bgRestartTimer(state){
    if(bgRotationTimer){
      clearTimeout(bgRotationTimer);
      bgRotationTimer = null;
    }
    if(!state.rotation.enabled || state.rotation.locked) return;
    const delay = bgComputeDelay(state);
    if(!delay) return;
    bgRotationTimer = setTimeout(() => bgRunRotation('timer'), delay);
  }

  function bgRunRotation(trigger){
    const state = bgLoadState();
    if(!state.rotation.enabled || state.rotation.locked) return;
    let ref = null;
    if(state.rotation.strategy === 'time') ref = bgPickSlot(state);
    else if(state.rotation.strategy === 'theme') ref = bgPickTheme(state);
    if(!ref){
      const candidates = bgCollectCandidates(state, false);
      if(candidates.length) ref = bgCloneRef(candidates[Math.floor(Math.random() * candidates.length)]);
    }
    if(ref) bgApply(ref, { skipSchedule: true, fromAuto: true });
    bgRestartTimer(bgLoadState());
  }

  function bgEvaluateRotation(reason){
    const state = bgLoadState();
    if(!state.rotation.enabled || state.rotation.locked) return;
    let ref = null;
    if(state.rotation.strategy === 'time') ref = bgPickSlot(state);
    else if(state.rotation.strategy === 'theme') ref = bgPickTheme(state);
    if(ref){
      const nextKey = bgRefKey(ref);
      if(nextKey && nextKey !== bgRefKey(state.active)) bgApply(ref, { fromAuto: true });
    }
    bgRestartTimer(bgLoadState());
  }

  function bgInitBackgroundEngine(){
    const engine = document.getElementById('bgEngine');
    if(!engine) return;
    engine.addEventListener('click', bgHandleClick);
    engine.addEventListener('change', bgHandleChange);
    engine.addEventListener('dragover', bgHandleDrag);
    engine.addEventListener('dragleave', bgHandleDrag);
    engine.addEventListener('drop', bgHandleDrop);
    bgRenderSettings();
    bgApply();
    const state = bgLoadState();
    bgRestartTimer(state);
    bgEvaluateRotation('startup');
  }

  function bgOnThemeChange(){
    bgEvaluateRotation('theme');
  }

  function applyBackground(ref){
    return bgApply(ref);
  }

  // ===== System Status
  function renderSystem(){
    const info = [];
    if('deviceMemory' in navigator) info.push(`RAM: ${navigator.deviceMemory} GB`);
    if('hardwareConcurrency' in navigator) info.push(`CPU‑Kerne: ${navigator.hardwareConcurrency}`);
    if('connection' in navigator && navigator.connection){
      const c = navigator.connection;
      info.push(`Netz: ${c.downlink ?? '–'} Mbit/s · ${c.effectiveType ?? '–'}${c.saveData? ' · SaveData':''}`);
    }
    $('#systemInfo').innerHTML = info.length? info.join('<br>') : 'Keine Daten verfügbar';
  }

  // ===== Widgets visibility
  function widgetDefaults(){
    return { todo:true, notes:true, tiles:true, weather:true, quote:true, recent:true, system:true, news:true };
  }
  function applyWidgets(){
    const conf = store.get('widgets', widgetDefaults());
    const map = { todo:'#todo', notes:'#notes', tiles:'#tilesCard', weather:'#weather', quote:'#quoteCard', recent:'#recent', system:'#systemCard', news:'#newsCard' };
    Object.entries(map).forEach(([k,sel])=>{ const el=$(sel); if(el) el.style.display = conf[k] ? '' : 'none'; });
  }

  // ===== Widget colors
  function widgetColorDefaults(){
    return { todo:'', notes:'', tiles:'', weather:'', quote:'', recent:'', system:'', news:'' };
  }
  function hexToRgba(hex, a=0.18){
    if(!hex) return '';
    let h = hex.replace('#','');
    if(h.length===3) h = h.split('').map(c=>c+c).join('');
    const r = parseInt(h.slice(0,2),16); const g = parseInt(h.slice(2,4),16); const b = parseInt(h.slice(4,6),16);
    if([r,g,b].some(v=>Number.isNaN(v))) return '';
    return `rgba(${r},${g},${b},${a})`;
  }
  function applyWidgetColors(){
    const colors = store.get('widget.colors', widgetColorDefaults());
    const map = { todo:'#todo', notes:'#notes', tiles:'#tilesCard', weather:'#weather', quote:'#quoteCard', recent:'#recent', system:'#systemCard', news:'#newsCard' };
    Object.entries(map).forEach(([k,sel])=>{
      const el = $(sel); if(!el) return;
      const hex = colors[k];
      if(hex){
        const tint = hexToRgba(hex, 0.18);
        const border = hexToRgba(hex, 0.28);
        el.style.background = `linear-gradient(0deg, ${tint}, ${tint}), var(--glass)`;
        el.style.borderColor = border || 'rgba(255,255,255,.08)';
      } else {
        el.style.background = '';
        el.style.borderColor = '';
      }
    });
  }

  function normalizeHex(hex){
    if(typeof hex !== 'string') return '';
    let h = hex.trim();
    if(!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(h)) return '';
    if(h.length === 4) h = '#' + h[1]+h[1]+h[2]+h[2]+h[3]+h[3];
    return `#${h.slice(1).toLowerCase()}`;
  }

  function applySurfaceColor(prefix, raw){
    const root = document.documentElement; if(!root) return;
    const hex = normalizeHex(raw);
    if(hex){
      const border = hexToRgba(hex, 0.42) || hex;
      const shadow = hexToRgba(hex, prefix==='search' ? 0.2 : 0.24) || 'rgba(0,0,0,.2)';
      root.style.setProperty(`--${prefix}-bg`, hex);
      root.style.setProperty(`--${prefix}-border`, border);
      root.style.setProperty(`--${prefix}-shadow`, `0 10px 28px ${shadow}`);
      root.style.setProperty(`--${prefix}-backdrop`, 'none');
    } else {
      const body = document.body;
      const bodyStyle = body ? getComputedStyle(body) : null;
      const rootStyle = getComputedStyle(root);
      const bg = (bodyStyle && bodyStyle.getPropertyValue('--card-bg-current').trim()) || rootStyle.getPropertyValue('--card-bg-current').trim() || 'transparent';
      const border = (bodyStyle && bodyStyle.getPropertyValue('--card-border-current').trim()) || rootStyle.getPropertyValue('--card-border-current').trim() || 'transparent';
      const shadow = (bodyStyle && bodyStyle.getPropertyValue('--card-shadow-current').trim()) || rootStyle.getPropertyValue('--card-shadow-current').trim() || 'none';
      const backdrop = (bodyStyle && bodyStyle.getPropertyValue('--card-backdrop-current').trim()) || rootStyle.getPropertyValue('--card-backdrop-current').trim() || 'none';
      root.style.setProperty(`--${prefix}-bg`, bg);
      root.style.setProperty(`--${prefix}-border`, border);
      root.style.setProperty(`--${prefix}-shadow`, shadow);
      root.style.setProperty(`--${prefix}-backdrop`, backdrop);
    }
  }

  function applySurfaceColors(){
    applySurfaceColor('clock', store.get('ui.clock.color',''));
    applySurfaceColor('search', store.get('ui.search.color',''));
  }

  function applyCardStyle(){
    const body = document.body; if(!body) return;
    const current = store.get('ui.cardStyle','glass');
    const allowed = ['glass','solid','transparent','minimal'];
    const value = allowed.includes(current) ? current : 'glass';
    body.setAttribute('data-card-style', value);
    applySurfaceColors();
  }

  function cycleCardStyle(){
    const order = ['glass','solid','transparent','minimal'];
    const current = store.get('ui.cardStyle','glass');
    const idx = order.indexOf(current);
    const next = order[(idx + 1) % order.length];
    store.set('ui.cardStyle', next);
    applyCardStyle();
    const modal = $('#settingsModal');
    if(modal && modal.classList.contains('open')) fillSettings();
  }

  function resetSurfaceColors(){
    store.set('ui.clock.color','');
    store.set('ui.search.color','');
    applySurfaceColors();
    const modal = $('#settingsModal');
    if(modal && modal.classList.contains('open')) fillSettings();
  }

  // ===== Command Palette (Ctrl/Cmd+K)
  function buildPaletteItems(){
    const items = [];
    // Commands
    items.push({ t:'Suche fokussieren', k:'/', a: ()=> $('#query').focus() });
    items.push({ t:'Einstellungen öffnen', k:'S', a: openSettings });
    items.push({ t:'Theme wechseln (Auto/Dark/Light)', k:'T', a: ()=>{ const cur=store.get('theme','auto'); const next = cur==='dark' ? 'light' : cur==='light' ? 'auto' : 'dark'; store.set('theme', next); applyTheme(next); }});
    items.push({ t:'Kachel-Stil wechseln', k:'C', a: cycleCardStyle });
    items.push({ t:'Header-Farben zurücksetzen', a: resetSurfaceColors });
    items.push({ t:'Tile hinzufügen', k:'+', a: addTile });
    items.push({ t:'Erledigte Todos löschen', k:'⌫', a: ()=>{ const list=store.get('todos',[]).filter(t=>!t.done); store.set('todos', list); renderTodos(); }});
    items.push({ t:'News aktualisieren', a: loadNews });
    items.push({ t:'Wetter aktualisieren', a: loadWeather });

    // Tiles
    const tiles = store.get('tiles', defaultTiles());
    tiles.forEach((t,i)=> items.push({ t:`${t.title}`, s:t.url, a: ()=> openUrl(t.url, t.title) }));
    return items;
  }
  function fuzzyIncludes(text, q){
    text = (text||'').toLowerCase(); q = (q||'').toLowerCase();
    if(!q) return true;
    let i=0; for(const ch of text){ if(ch===q[i]) i++; if(i===q.length) return true; }
    return false;
  }
  function openPalette(){
    const modal = $('#palette'); const input = $('#paletteInput'); const list = $('#paletteList');
    const all = buildPaletteItems(); let filtered = all.slice(); let idx = 0;
    function render(){
      list.innerHTML='';
      filtered.forEach((it,i)=>{
        const li = document.createElement('li');
        li.className = 'palette-item' + (i===idx ? ' active':'');
        li.innerHTML = `<span>${escapeHtml(it.t)}</span>${it.s?`<span class="muted">${escapeHtml(it.s)}</span>`:''}${it.k?`<span class="k">${it.k}</span>`:''}`;
        li.addEventListener('click', ()=>{ it.a && it.a(); closePalette(); });
        list.appendChild(li);
      });
    }
    function applyFilter(){ const q=input.value.trim(); filtered = all.filter(it=> fuzzyIncludes(it.t+' '+(it.s||''), q)); idx=0; render(); }
    function onKey(e){
      if(e.key==='Escape'){ e.preventDefault(); closePalette(); }
      else if(e.key==='ArrowDown'){ e.preventDefault(); idx = Math.min(idx+1, Math.max(0, filtered.length-1)); render(); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); idx = Math.max(idx-1, 0); render(); }
      else if(e.key==='Enter'){ e.preventDefault(); const it=filtered[idx]; if(it){ it.a && it.a(); closePalette(); } }
    }
    modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
    input.value=''; input.focus(); render();
    input.addEventListener('input', applyFilter);
    document.addEventListener('keydown', onKey);
    modal.addEventListener('click', e=>{ if(e.target.id==='palette') closePalette(); });
    function closePalette(){
      modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
      input.removeEventListener('input', applyFilter);
      document.removeEventListener('keydown', onKey);
    }
    // expose for ESC in global handler
    window.__closePalette = closePalette;
  }

  // ===== Init
  function init(){
    // Theme
    const theme = store.get('theme','auto');
    applyTheme(theme);
    applyCardStyle();
    $('#themeToggle').addEventListener('click', ()=>{
      const current = store.get('theme','auto');
      const next = current==='dark' ? 'light' : current==='light' ? 'auto' : 'dark';
      store.set('theme', next); applyTheme(next);
    });
    $('#openSettings').addEventListener('click', openSettings);
    $('#closeSettings').addEventListener('click', closeSettings);
    $('#themeSelect').addEventListener('change', e=>{ store.set('theme', e.target.value); applyTheme(e.target.value); });
    if(window.matchMedia){
      const media = matchMedia('(prefers-color-scheme: dark)');
      if(media && media.addEventListener){
        media.addEventListener('change', () => { if(store.get('theme','auto') === 'auto') bgOnThemeChange(); });
      }
    }
    $('#defaultCity').addEventListener('change', e=>{ store.set('weather.city', e.target.value.trim()); loadWeather(); });

    const cardSelect = $('#cardStyle');
    if(cardSelect) cardSelect.addEventListener('change', e=>{ const allowed = ['glass','solid','transparent','minimal']; const val = allowed.includes(e.target.value) ? e.target.value : 'glass'; store.set('ui.cardStyle', val); applyCardStyle(); if(val !== e.target.value) fillSettings(); });
    const clockColorInput = $('#clockColor');
    if(clockColorInput) clockColorInput.addEventListener('input', ()=>{ const val = normalizeHex(clockColorInput.value); store.set('ui.clock.color', val); applySurfaceColors(); });
    const clockReset = $('#clockColorReset'); if(clockReset) clockReset.addEventListener('click', ()=>{ store.set('ui.clock.color',''); applySurfaceColors(); fillSettings(); });
    const searchColorInput = $('#searchColor');
    if(searchColorInput) searchColorInput.addEventListener('input', ()=>{ const val = normalizeHex(searchColorInput.value); store.set('ui.search.color', val); applySurfaceColors(); });
    const searchReset = $('#searchColorReset'); if(searchReset) searchReset.addEventListener('click', ()=>{ store.set('ui.search.color',''); applySurfaceColors(); fillSettings(); });

    // Engines & Search
    renderEngines();
    $('#go').addEventListener('click', doSearch);
    $('#query').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

    // Export / Import
    const exp = $('#exportData'); if(exp) exp.addEventListener('click', exportData);
    const imp = $('#importData'); if(imp) imp.addEventListener('click', ()=> $('#importFile').click());
    const file = $('#importFile'); if(file) file.addEventListener('change', importDataFromFile);

    // Persist settings fields (shortcuts & feeds)
    $('#shortcutConfig').addEventListener('change', ()=>{ try{ const j=JSON.parse($('#shortcutConfig').value); store.set('shortcuts', j);}catch{ alert('Ungültiges Shortcuts‑JSON'); } });
    $('#feedsConfig').addEventListener('change', ()=>{ try{ const j=JSON.parse($('#feedsConfig').value); store.set('news.custom', j); fillNewsSources(); loadNews(); }catch{ alert('Ungültiges Feeds‑JSON'); } });

    // Clock
    tickClock();

    // Todo
    renderTodos();
    $('#todoAdd').addEventListener('click', ()=>{ const v=$('#todoInput').value.trim(); if(v){ addTodo(v); $('#todoInput').value=''; }});
    $('#todoInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#todoAdd').click(); } });
    $('#todoClearDone').addEventListener('click', ()=>{ const list=store.get('todos',[]).filter(t=>!t.done); store.set('todos', list); renderTodos(); });

    // Notes
    initNotes();

    // Tiles
    if(!localStorage.getItem('tiles')) store.set('tiles', defaultTiles());
    renderTiles();
    $('#addTile').addEventListener('click', addTile);
    $('#resetTiles').addEventListener('click', ()=>{ if(confirm('Standard‑Kacheln wiederherstellen?')){ store.set('tiles', defaultTiles()); renderTiles(); }});

    // Weather
    $('#setCity').addEventListener('click', ()=>{ const v=$('#cityInput').value.trim(); if(v){ store.set('weather.city', v); loadWeather(); }});
    loadWeather();

    // Quote
    loadQuote();

    // Recent
    renderRecent();

    // Background
    bgInitBackgroundEngine();
    applyBackground();

    // System
    renderSystem();
    if(navigator.connection && 'onchange' in navigator.connection){ navigator.connection.addEventListener('change', renderSystem); }

    // News
    fillNewsSources(); loadNews();
    $('#newsSource').addEventListener('change', e=>{ store.set('news.source', e.target.value); loadNews(); });
    $('#refreshNews').addEventListener('click', loadNews);

    // Widgets visibility
    applyWidgets();
    applyWidgetColors();

    // Close modal on Escape / overlay click
    $('#settingsModal').addEventListener('click', e=>{ if(e.target.id==='settingsModal') closeSettings(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeSettings(); });

    // Command Palette (Ctrl/Cmd+K)
    document.addEventListener('keydown', e=>{
      const target = e.target;
      const isTyping = target && (target.tagName==='INPUT' || target.tagName==='TEXTAREA' || target.isContentEditable);
      if((e.ctrlKey||e.metaKey) && (e.key==='k' || e.key==='K')){ e.preventDefault(); openPalette(); return; }
      // Quick keys 1-9 for tiles when not typing
      if(!isTyping && !e.altKey && !e.ctrlKey && !e.metaKey && /^[1-9]$/.test(e.key)){
        const n = Number(e.key)-1; const tiles = store.get('tiles', defaultTiles());
        if(tiles[n]) openUrl(tiles[n].url, tiles[n].title);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
